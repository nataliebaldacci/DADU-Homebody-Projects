<!DOCTYPE html>
<html>
<head>
    <title>Nashville ADU Permits Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Avenir Next', Arial, sans-serif; }
        #map { position: absolute; top: 60px; bottom: 0; width: 100%; }
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 500;
        }
        .header .count {
            margin-left: 20px;
            background: #6b8fa3;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 13px;
        }
        .legend h4 { margin: 0 0 10px 0; color: #2c3e50; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; }
        .popup-content h3 { margin: 0 0 10px 0; color: #2c3e50; font-size: 16px; }
        .popup-content p { margin: 5px 0; font-size: 13px; }
        .popup-content .label { font-weight: 600; color: #555; }
        .year-filter {
            position: absolute;
            top: 80px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .year-filter h4 { margin: 0 0 10px 0; font-size: 14px; }
        .year-filter select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
            width: 120px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† Nashville ADU Permits (1991-2025)</h1>
        <span class="count" id="permit-count">Loading...</span>
    </div>
    
    <div class="year-filter">
        <h4>Filter by Year</h4>
        <select id="year-select">
            <option value="all">All Years</option>
        </select>
    </div>
    
    <div id="map"></div>
    
    <div class="legend">
        <h4>Permit Year</h4>
        <div class="legend-item"><div class="legend-color" style="background: #1a9850;"></div> 2020-2025</div>
        <div class="legend-item"><div class="legend-color" style="background: #91cf60;"></div> 2015-2019</div>
        <div class="legend-item"><div class="legend-color" style="background: #fee08b;"></div> 2010-2014</div>
        <div class="legend-item"><div class="legend-color" style="background: #fc8d59;"></div> 2005-2009</div>
        <div class="legend-item"><div class="legend-color" style="background: #d73027;"></div> Before 2005</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        // Initialize map centered on Nashville
        const map = L.map('map').setView([36.1627, -86.7816], 11);
        
        // Add tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors ¬© CARTO',
            maxZoom: 19
        }).addTo(map);

        // Color function based on year
        function getColor(year) {
            if (!year) return '#999';
            const y = parseInt(year);
            if (y >= 2020) return '#1a9850';
            if (y >= 2015) return '#91cf60';
            if (y >= 2010) return '#fee08b';
            if (y >= 2005) return '#fc8d59';
            return '#d73027';
        }

        // Store all data and markers
        let allData = [];
        let markers = L.markerClusterGroup({
            chunkedLoading: true,
            maxClusterRadius: 50
        });

        // Load GeoJSON
        fetch('NEW_ADU_Permits_20260114.geojson')
            .then(response => response.json())
            .then(data => {
                allData = data.features;
                document.getElementById('permit-count').textContent = `${allData.length.toLocaleString()} permits`;
                
                // Get unique years for filter
                const years = [...new Set(allData.map(f => {
                    const date = f.properties.PERMIT_DATE || f.properties.FILE_DATE || '';
                    return date.substring(0, 4);
                }).filter(y => y))].sort().reverse();
                
                const select = document.getElementById('year-select');
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                });
                
                // Add markers
                updateMarkers('all');
                
                // Filter change handler
                select.addEventListener('change', (e) => {
                    updateMarkers(e.target.value);
                });
            });

        function updateMarkers(yearFilter) {
            markers.clearLayers();
            
            let filtered = allData;
            if (yearFilter !== 'all') {
                filtered = allData.filter(f => {
                    const date = f.properties.PERMIT_DATE || f.properties.FILE_DATE || '';
                    return date.startsWith(yearFilter);
                });
            }
            
            document.getElementById('permit-count').textContent = `${filtered.length.toLocaleString()} permits`;
            
            filtered.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;
                const year = (props.PERMIT_DATE || props.FILE_DATE || '').substring(0, 4);
                
                const marker = L.circleMarker([coords[1], coords[0]], {
                    radius: 6,
                    fillColor: getColor(year),
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                const popupContent = `
                    <div class="popup-content">
                        <h3>${props.STREET || 'Unknown Address'}</h3>
                        <p><span class="label">Date:</span> ${props.PERMIT_DATE || props.FILE_DATE || 'N/A'}</p>
                        <p><span class="label">Permit #:</span> ${props.PERMIT_NUMBER || 'N/A'}</p>
                        <p><span class="label">Type:</span> ${props.ACCESSORY_STRUCTURE_TYPE || props.ADU_TYPE || 'N/A'}</p>
                        <p><span class="label">Owner:</span> ${props.OWNER_NAME || 'N/A'}</p>
                        <p><span class="label">Contractor:</span> ${props.CONTRACTOR_BIZ_NAME_ORIGINAL || 'N/A'}</p>
                        <p><span class="label">Fees:</span> $${props.FEES_JSON || props.TOTAL_FEES || 'N/A'}</p>
                        <p><span class="label">Status:</span> ${props.STATUS_NORMALIZED || 'N/A'}</p>
                        ${props.PROJECT_SCOPE ? `<p><span class="label">Scope:</span> ${props.PROJECT_SCOPE.substring(0, 200)}...</p>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent, { maxWidth: 350 });
                markers.addLayer(marker);
            });
            
            map.addLayer(markers);
        }
    </script>
</body>
</html>
