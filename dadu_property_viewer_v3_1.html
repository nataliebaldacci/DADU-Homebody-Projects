<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property | Homebody Projects</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f5f5f0;
            color: #333;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: #6b8e4e;
        }

        .logo span {
            color: #2c3e50;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: #f5f5f0;
            border-radius: 8px;
            padding: 8px 16px;
            width: 400px;
            gap: 8px;
        }

        .search-bar svg {
            width: 18px;
            height: 18px;
            color: #888;
            flex-shrink: 0;
        }

        .search-bar input {
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
        }

        .nav-tab {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            text-decoration: none;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            background: #f0f0f0;
            color: #333;
        }

        .nav-tab.active {
            background: #6b8e4e;
            color: white;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #6b8fa3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            margin-top: 60px;
            height: calc(100vh - 60px);
        }

        /* Left Sidebar */
        .sidebar {
            width: 420px;
            background: #fff;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        /* Tab Navigation in Sidebar */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
            flex-wrap: wrap;
        }

        .sidebar-tab {
            flex: 1;
            min-width: 70px;
            padding: 12px 6px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .sidebar-tab:hover {
            color: #333;
            background: #f0f0f0;
        }

        .sidebar-tab.active {
            color: #6b8e4e;
            border-bottom-color: #6b8e4e;
            background: #fff;
        }

        .sidebar-tab svg {
            display: block;
            margin: 0 auto 4px;
            width: 18px;
            height: 18px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Eligibility Banner */
        .eligibility-banner {
            padding: 16px 20px;
            background: #e8f5e9;
            border-bottom: 1px solid #c8e6c9;
        }

        .eligibility-banner.eligible {
            background: #e8f5e9;
            border-color: #c8e6c9;
        }

        .eligibility-banner.not-eligible {
            background: #ffebee;
            border-color: #ffcdd2;
        }

        .eligibility-banner.checking {
            background: #fff3e0;
            border-color: #ffe0b2;
        }

        .eligibility-text {
            font-size: 15px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 6px;
        }

        .eligibility-banner.not-eligible .eligibility-text {
            color: #c62828;
        }

        .eligibility-banner.checking .eligibility-text {
            color: #ef6c00;
        }

        .eligibility-note {
            font-size: 12px;
            color: #666;
        }

        /* Property Section */
        .property-section {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .property-section:last-child {
            border-bottom: none;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 15px;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title svg {
            width: 18px;
            height: 18px;
            color: #6b8fa3;
        }

        .section-subtitle {
            font-size: 12px;
            color: #888;
            margin-bottom: 12px;
        }

        .edit-btn {
            padding: 5px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fff;
            font-family: inherit;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-btn:hover {
            border-color: #6b8fa3;
            color: #6b8fa3;
        }

        .property-row {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .property-row:last-child {
            border-bottom: none;
        }

        .property-label {
            font-size: 12px;
            color: #666;
        }

        .property-value {
            font-size: 13px;
            color: #333;
            font-weight: 600;
            text-align: right;
        }

        .property-value.highlight {
            color: #6b8e4e;
        }

        .property-value.warning {
            color: #ef6c00;
        }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 10px;
            padding: 14px;
            color: white;
            text-align: center;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #6b8e4e 0%, #5a7a3f 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #6b8fa3 0%, #5a7d91 100%);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.85;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Permit List */
        .permit-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .permit-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 14px;
            border: 1px solid #e8e8e8;
            cursor: pointer;
            transition: all 0.2s;
        }

        .permit-card:hover {
            border-color: #6b8fa3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .permit-card.active {
            border-color: #6b8e4e;
            background: #f0f7ec;
        }

        .permit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .permit-address {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
        }

        .permit-distance {
            font-size: 11px;
            color: #888;
            background: #fff;
            padding: 3px 8px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .permit-details {
            display: flex;
            gap: 16px;
            margin-bottom: 8px;
        }

        .permit-detail {
            font-size: 11px;
            color: #666;
        }

        .permit-detail strong {
            color: #333;
        }

        .permit-contractor {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b8fa3;
        }

        .permit-contractor svg {
            width: 14px;
            height: 14px;
        }

        /* Contractor List */
        .contractor-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .contractor-card {
            background: #fff;
            border-radius: 10px;
            padding: 14px;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .contractor-card:hover {
            border-color: #6b8e4e;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .contractor-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #6b8e4e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .contractor-rank.silver {
            background: #95a5a6;
        }

        .contractor-rank.bronze {
            background: #c9a86c;
        }

        .contractor-info {
            flex: 1;
        }

        .contractor-name {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .contractor-stats {
            font-size: 11px;
            color: #666;
        }

        .contractor-stats span {
            margin-right: 12px;
        }

        .contractor-arrow {
            color: #ccc;
        }

        /* Action Buttons */
        .btn {
            padding: 10px 14px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
        }

        .btn-green {
            background: #6b8e4e;
            border: 2px solid #6b8e4e;
            color: white;
        }

        .btn-green:hover {
            background: #5a7a3f;
            border-color: #5a7a3f;
        }

        .btn-outline {
            background: #fff;
            border: 2px solid #e0e0e0;
            color: #333;
        }

        .btn-outline:hover {
            border-color: #6b8fa3;
            color: #6b8fa3;
        }

        /* Tax Card */
        .tax-card {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            margin-bottom: 16px;
        }

        .tax-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .tax-card-title {
            font-size: 12px;
            font-weight: 500;
            opacity: 0.8;
        }

        .tax-card-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .tax-amount {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .tax-amount-label {
            font-size: 12px;
            opacity: 0.7;
        }

        .tax-comparison {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .tax-compare-item {
            flex: 1;
        }

        .tax-compare-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .tax-compare-value {
            font-size: 18px;
            font-weight: 600;
        }

        .tax-compare-value.increase {
            color: #ff6b6b;
        }

        /* Slider */
        .slider-container {
            margin: 16px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-label span {
            font-size: 12px;
            color: #666;
        }

        .slider-label strong {
            font-size: 14px;
            color: #333;
        }

        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #6b8e4e;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Legal Checklist */
        .checklist {
            list-style: none;
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .checklist-icon.check {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .checklist-icon.warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .checklist-icon.info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .checklist-icon svg {
            width: 14px;
            height: 14px;
        }

        .checklist-content {
            flex: 1;
        }

        .checklist-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .checklist-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .checklist-link {
            color: #6b8fa3;
            text-decoration: none;
        }

        .checklist-link:hover {
            text-decoration: underline;
        }

        /* ROI Calculator */
        .roi-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .roi-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .roi-label {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        .roi-input {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }

        .roi-input:focus {
            outline: none;
            border-color: #6b8fa3;
        }

        .roi-results {
            background: #f5f5f0;
            border-radius: 8px;
            padding: 16px;
        }

        .roi-result-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .roi-result-row:last-child {
            border-bottom: none;
            padding-top: 12px;
        }

        .roi-result-label {
            font-size: 13px;
            color: #666;
        }

        .roi-result-value {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        .roi-result-value.highlight {
            font-size: 16px;
            color: #6b8e4e;
        }

        /* Info Callout */
        .info-callout {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            margin: 16px 0;
        }

        .info-callout-title {
            font-size: 12px;
            font-weight: 700;
            color: #1565c0;
            margin-bottom: 4px;
        }

        .info-callout p {
            font-size: 12px;
            color: #333;
            line-height: 1.5;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Map Tools */
        .map-tools {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            display: flex;
            gap: 4px;
            padding: 6px;
            z-index: 500;
        }

        .map-tool {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 14px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            gap: 4px;
        }

        .map-tool:hover {
            background: #f5f5f0;
        }

        .map-tool.active {
            background: #e8f5e9;
        }

        .map-tool svg {
            width: 18px;
            height: 18px;
            color: #666;
        }

        .map-tool.active svg {
            color: #6b8e4e;
        }

        .map-tool span {
            font-size: 10px;
            color: #666;
        }

        /* Map Legend */
        .map-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            padding: 12px 16px;
            z-index: 500;
            font-size: 12px;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.parcel {
            background: #6b8fa3;
            border: 2px dashed #2c3e50;
        }

        .legend-dot.permit {
            background: #6b8e4e;
        }

        .legend-dot.building {
            background: #2c3e50;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 500;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #666;
        }

        .zoom-btn:hover {
            background: #f5f5f0;
        }

        /* Loading */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 600;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: #6b8e4e;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: #666;
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 16px;
        }

        .footer-link {
            font-size: 12px;
            color: #6b8fa3;
            text-decoration: none;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        /* Custom marker */
        .permit-marker {
            background: #6b8e4e;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">Homebody<span>Projects</span></div>
        
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="addressSearch" placeholder="Enter Nashville address...">
        </div>

        <nav class="nav-tabs">
            <a href="#" class="nav-tab active">Property</a>
            <a href="#" class="nav-tab">Designs</a>
            <a href="#" class="nav-tab">Sketch</a>
            <a href="#" class="nav-tab">DADU Report</a>
        </nav>

        <div class="user-avatar">NB</div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <!-- Sidebar Tabs -->
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="switchTab('property')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Property
                </div>
                <div class="sidebar-tab" onclick="switchTab('permits')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="10" r="3"></circle>
                        <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"></path>
                    </svg>
                    Nearby
                </div>
                <div class="sidebar-tab" onclick="switchTab('contractors')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Contractors
                </div>
                <div class="sidebar-tab" onclick="switchTab('taxes')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    Taxes
                </div>
                <div class="sidebar-tab" onclick="switchTab('legal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    Legal
                </div>
                <div class="sidebar-tab" onclick="switchTab('roi')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    ROI
                </div>
            </div>

            <!-- PROPERTY TAB -->
            <div class="tab-content active" id="tab-property">
                <div class="eligibility-banner checking" id="eligibilityBanner">
                    <div class="eligibility-text" id="eligibilityText">
                        Enter an address to check DADU eligibility
                    </div>
                    <div class="eligibility-note" id="eligibilityNote">
                        Based on BL2025-1007, effective December 12, 2025
                    </div>
                </div>

                <div class="property-section">
                    <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                        <button class="btn btn-outline" style="flex: 1;">Browse Designs</button>
                        <button class="btn btn-green" style="flex: 1;">Sketch a DADU</button>
                    </div>
                    <button class="btn btn-outline" style="width: 100%;">Generate DADU Report (PDF)</button>
                </div>

                <div class="property-section">
                    <div class="section-header">
                        <h2 class="section-title">Property Information</h2>
                        <button class="edit-btn" onclick="openEditModal()">Edit</button>
                    </div>

                    <div class="property-row">
                        <div class="property-label">Address</div>
                        <div class="property-value" id="propAddress">-</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Lot Area</div>
                        <div class="property-value" id="propLotArea">-</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Parcel Number</div>
                        <div class="property-value" id="propAPN">-</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Zoning</div>
                        <div class="property-value" id="propZoning">-</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Service District</div>
                        <div class="property-value" id="propDistrict">-</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Appraised Value</div>
                        <div class="property-value" id="propAppraisedValue">-</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Max DADU Size</div>
                        <div class="property-value highlight" id="propMaxDADU">-</div>
                    </div>
                </div>
            </div>

            <!-- NEARBY PERMITS TAB -->
            <div class="tab-content" id="tab-permits">
                <div class="property-section">
                    <h2 class="section-title" style="margin-bottom: 16px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="10" r="3"></circle>
                            <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"></path>
                        </svg>
                        DADUs Built Nearby
                    </h2>

                    <div class="stats-row">
                        <div class="stat-card green">
                            <div class="stat-value" id="nearbyCount">0</div>
                            <div class="stat-label">Within 1 Mile</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-value" id="avgCost">$0</div>
                            <div class="stat-label">Avg Cost</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgSize">0</div>
                            <div class="stat-label">Avg SqFt</div>
                        </div>
                    </div>

                    <p class="section-subtitle">Click a permit to see on map</p>

                    <div class="permit-list" id="permitList">
                        <div style="text-align: center; padding: 40px 20px; color: #888;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40" style="margin: 0 auto 12px; display: block; opacity: 0.5;">
                                <circle cx="12" cy="10" r="3"></circle>
                                <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"></path>
                            </svg>
                            Search an address to find<br>nearby DADU permits
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTRACTORS TAB -->
            <div class="tab-content" id="tab-contractors">
                <div class="property-section">
                    <h2 class="section-title" style="margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        Top DADU Contractors
                    </h2>
                    <p class="section-subtitle">Ranked by Nashville DADU permits completed</p>

                    <div class="contractor-list" id="contractorList">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="property-section">
                    <div class="info-callout">
                        <div class="info-callout-title">How We Rank Contractors</div>
                        <p>Rankings based on DADU building permits filed in Davidson County. We track permit count, average project cost, and completion rate. Contact info from public permit records.</p>
                    </div>
                    <button class="btn btn-green">Get Contractor Quotes</button>
                </div>
            </div>

            <!-- TAXES TAB -->
            <div class="tab-content" id="tab-taxes">
                <div class="property-section">
                    <h2 class="section-title" style="margin-bottom: 16px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        Property Tax Estimator
                    </h2>

                    <div class="tax-card">
                        <div class="tax-card-header">
                            <div>
                                <div class="tax-card-title">Estimated Annual Tax Increase</div>
                                <div class="tax-amount" id="taxIncrease">+$0</div>
                                <div class="tax-amount-label">per year after adding DADU</div>
                            </div>
                            <div class="tax-card-badge">ESTIMATE</div>
                        </div>
                        <div class="tax-comparison">
                            <div class="tax-compare-item">
                                <div class="tax-compare-label">Current Tax</div>
                                <div class="tax-compare-value" id="currentTax">$0</div>
                            </div>
                            <div class="tax-compare-item">
                                <div class="tax-compare-label">Projected Tax</div>
                                <div class="tax-compare-value increase" id="projectedTax">$0</div>
                            </div>
                        </div>
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Est. Construction Cost</span>
                            <strong id="constructionCostDisplay">$200,000</strong>
                        </div>
                        <input type="range" class="slider" id="constructionCostSlider" min="100000" max="400000" value="200000" step="10000">
                    </div>

                    <div class="info-callout">
                        <div class="info-callout-title">Davidson County Tax Formula</div>
                        <p>25% assessment ratio × $3.254 per $100 assessed value. DADU construction cost adds directly to your property's appraised value.</p>
                    </div>
                </div>
            </div>

            <!-- LEGAL TAB -->
            <div class="tab-content" id="tab-legal">
                <div class="property-section">
                    <h2 class="section-title" style="margin-bottom: 16px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 11 12 14 22 4"></polyline>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        Legal Checklist
                    </h2>

                    <ul class="checklist">
                        <li class="checklist-item">
                            <div class="checklist-icon info">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            </div>
                            <div class="checklist-content">
                                <div class="checklist-title">Owner-Occupancy Required</div>
                                <div class="checklist-desc">You must live in either the main house or DADU</div>
                            </div>
                        </li>
                        <li class="checklist-item">
                            <div class="checklist-icon warning">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            </div>
                            <div class="checklist-content">
                                <div class="checklist-title">Restrictive Covenants</div>
                                <div class="checklist-desc">Check deed for restrictions. <a href="https://registerofdeeds.nashville.gov" class="checklist-link" target="_blank">Search Register of Deeds →</a></div>
                            </div>
                        </li>
                        <li class="checklist-item">
                            <div class="checklist-icon check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                            <div class="checklist-content">
                                <div class="checklist-title">Short-Term Rentals</div>
                                <div class="checklist-desc">Allowed with owner on-site + STR permit</div>
                            </div>
                        </li>
                        <li class="checklist-item">
                            <div class="checklist-icon info">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            </div>
                            <div class="checklist-content">
                                <div class="checklist-title">Floodplain Status</div>
                                <div class="checklist-desc"><a href="https://maps.nashville.gov/stormwater" class="checklist-link" target="_blank">Check Flood Map →</a></div>
                            </div>
                        </li>
                        <li class="checklist-item">
                            <div class="checklist-icon check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                            <div class="checklist-content">
                                <div class="checklist-title">Utility Connections</div>
                                <div class="checklist-desc">Separate meters required (NES + Metro Water)</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- ROI TAB -->
            <div class="tab-content" id="tab-roi">
                <div class="property-section">
                    <h2 class="section-title" style="margin-bottom: 16px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        ROI Calculator
                    </h2>

                    <div class="roi-inputs">
                        <div class="roi-input-group">
                            <label class="roi-label">Construction ($)</label>
                            <input type="number" class="roi-input" id="roiConstructionCost" value="200000">
                        </div>
                        <div class="roi-input-group">
                            <label class="roi-label">Monthly Rent ($)</label>
                            <input type="number" class="roi-input" id="roiMonthlyRent" value="1400">
                        </div>
                        <div class="roi-input-group">
                            <label class="roi-label">Vacancy (%)</label>
                            <input type="number" class="roi-input" id="roiVacancyRate" value="5">
                        </div>
                        <div class="roi-input-group">
                            <label class="roi-label">Annual Costs ($)</label>
                            <input type="number" class="roi-input" id="roiOperatingCosts" value="2400">
                        </div>
                    </div>

                    <button class="btn btn-green" style="width: 100%; margin-bottom: 16px;" onclick="calculateROI()">Calculate</button>

                    <div class="roi-results">
                        <div class="roi-result-row">
                            <span class="roi-result-label">Net Operating Income</span>
                            <span class="roi-result-value" id="roiNOI">$11,933</span>
                        </div>
                        <div class="roi-result-row">
                            <span class="roi-result-label">Cash-on-Cash Return</span>
                            <span class="roi-result-value highlight" id="roiCashReturn">5.97%</span>
                        </div>
                        <div class="roi-result-row">
                            <span class="roi-result-label">Break-Even</span>
                            <span class="roi-result-value highlight" id="roiBreakEven">16.8 years</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <a href="#" class="footer-link">Send Feedback</a>
                <a href="#" class="footer-link">Help</a>
                <a href="#" class="footer-link">Data Sources</a>
            </div>
        </aside>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>

            <div class="loading-overlay hidden" id="loadingOverlay">
                <div class="spinner"></div>
                <div class="loading-text" id="loadingText">Loading...</div>
            </div>

            <div class="map-legend" id="mapLegend" style="display: none;">
                <div class="legend-title">Map Legend</div>
                <div class="legend-item">
                    <div class="legend-dot parcel"></div>
                    <span>Your Parcel</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot permit"></div>
                    <span>DADU Permits</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot building"></div>
                    <span>Buildings</span>
                </div>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" onclick="map.zoomIn()">+</button>
                <button class="zoom-btn" onclick="map.zoomOut()">−</button>
            </div>

            <div class="map-tools">
                <button class="map-tool" onclick="toggleTool('edit')" id="editTool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    <span>Edit</span>
                </button>
                <button class="map-tool" onclick="toggleTool('measure')" id="measureTool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 12h20"></path>
                        <path d="M6 8v8"></path>
                        <path d="M18 8v8"></path>
                    </svg>
                    <span>Measure</span>
                </button>
                <button class="map-tool" onclick="toggleSatellite()" id="satelliteTool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    <span>Satellite</span>
                </button>
                <button class="map-tool" onclick="togglePermits()" id="permitsTool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="10" r="3"></circle>
                        <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"></path>
                    </svg>
                    <span>Permits</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // SAMPLE DADU PERMIT DATA (Replace with real data)
        // ============================================================
        const SAMPLE_PERMITS = [
            { id: 1, address: "1821 Beechwood Ave", lat: 36.1318, lon: -86.7642, contractor: "Nashville ADU Builders", cost: 185000, sqft: 720, date: "2024-08-15", status: "Complete" },
            { id: 2, address: "2205 Eastland Ave", lat: 36.1712, lon: -86.7342, contractor: "Green Building Co", cost: 210000, sqft: 800, date: "2024-07-22", status: "Complete" },
            { id: 3, address: "1408 Shelby Ave", lat: 36.1628, lon: -86.7521, contractor: "Nashville ADU Builders", cost: 175000, sqft: 650, date: "2024-09-03", status: "Complete" },
            { id: 4, address: "1015 Fatherland St", lat: 36.1685, lon: -86.7498, contractor: "Compact Living TN", cost: 195000, sqft: 750, date: "2024-06-18", status: "Complete" },
            { id: 5, address: "905 Boscobel St", lat: 36.1742, lon: -86.7412, contractor: "East Nashville Builds", cost: 220000, sqft: 850, date: "2024-05-10", status: "Complete" },
            { id: 6, address: "2411 Trevecca Ave", lat: 36.1495, lon: -86.7385, contractor: "Nashville ADU Builders", cost: 168000, sqft: 600, date: "2024-10-01", status: "In Progress" },
            { id: 7, address: "507 S 11th St", lat: 36.1598, lon: -86.7635, contractor: "Green Building Co", cost: 205000, sqft: 780, date: "2024-04-28", status: "Complete" },
            { id: 8, address: "1712 Lillian St", lat: 36.1755, lon: -86.7289, contractor: "Compact Living TN", cost: 190000, sqft: 700, date: "2024-08-08", status: "Complete" },
            { id: 9, address: "2104 15th Ave S", lat: 36.1385, lon: -86.7892, contractor: "Nashville ADU Builders", cost: 178000, sqft: 680, date: "2024-09-20", status: "Complete" },
            { id: 10, address: "1320 Holly St", lat: 36.1812, lon: -86.7545, contractor: "Hillsboro Homes", cost: 245000, sqft: 850, date: "2024-03-15", status: "Complete" },
            { id: 11, address: "903 Woodland St", lat: 36.1698, lon: -86.7565, contractor: "East Nashville Builds", cost: 198000, sqft: 740, date: "2024-07-05", status: "Complete" },
            { id: 12, address: "1506 Forrest Ave", lat: 36.1722, lon: -86.7438, contractor: "Green Building Co", cost: 215000, sqft: 800, date: "2024-06-25", status: "Complete" },
            { id: 13, address: "2301 Blair Blvd", lat: 36.1298, lon: -86.7975, contractor: "Hillsboro Homes", cost: 265000, sqft: 850, date: "2024-02-10", status: "Complete" },
            { id: 14, address: "1105 Calvin Ave", lat: 36.1668, lon: -86.7612, contractor: "Nashville ADU Builders", cost: 172000, sqft: 640, date: "2024-11-05", status: "In Progress" },
            { id: 15, address: "718 S 14th St", lat: 36.1545, lon: -86.7685, contractor: "Compact Living TN", cost: 188000, sqft: 720, date: "2024-08-30", status: "Complete" },
            { id: 16, address: "2008 Belmont Blvd", lat: 36.1328, lon: -86.7912, contractor: "Hillsboro Homes", cost: 275000, sqft: 850, date: "2024-01-20", status: "Complete" },
            { id: 17, address: "1401 5th Ave N", lat: 36.1785, lon: -86.7895, contractor: "Germantown Builders", cost: 235000, sqft: 820, date: "2024-04-12", status: "Complete" },
            { id: 18, address: "609 Monroe St", lat: 36.1802, lon: -86.7845, contractor: "Germantown Builders", cost: 248000, sqft: 850, date: "2024-05-28", status: "Complete" },
            { id: 19, address: "1215 6th Ave N", lat: 36.1768, lon: -86.7868, contractor: "Nashville ADU Builders", cost: 195000, sqft: 750, date: "2024-07-15", status: "Complete" },
            { id: 20, address: "3205 Belmont Blvd", lat: 36.1185, lon: -86.7945, contractor: "Green Building Co", cost: 225000, sqft: 800, date: "2024-06-02", status: "Complete" },
            { id: 21, address: "904 Stratford Ave", lat: 36.1355, lon: -86.7365, contractor: "East Nashville Builds", cost: 182000, sqft: 700, date: "2024-09-12", status: "Complete" },
            { id: 22, address: "1608 Russell St", lat: 36.1678, lon: -86.7478, contractor: "Compact Living TN", cost: 199000, sqft: 760, date: "2024-08-22", status: "Complete" },
            { id: 23, address: "2505 12th Ave S", lat: 36.1245, lon: -86.7865, contractor: "Nashville ADU Builders", cost: 185000, sqft: 720, date: "2024-10-15", status: "In Progress" },
            { id: 24, address: "1712 7th Ave N", lat: 36.1825, lon: -86.7912, contractor: "Germantown Builders", cost: 255000, sqft: 850, date: "2024-03-28", status: "Complete" },
            { id: 25, address: "408 N 17th St", lat: 36.1695, lon: -86.7325, contractor: "East Nashville Builds", cost: 205000, sqft: 780, date: "2024-05-18", status: "Complete" },
        ];

        // Contractor summary from permits
        const CONTRACTORS = [
            { name: "Nashville ADU Builders", permits: 7, avgCost: 182571, rating: 4.8, phone: "(615) 555-0101" },
            { name: "Green Building Co", permits: 4, avgCost: 213750, rating: 4.7, phone: "(615) 555-0102" },
            { name: "Compact Living TN", permits: 4, avgCost: 193000, rating: 4.6, phone: "(615) 555-0103" },
            { name: "East Nashville Builds", permits: 4, avgCost: 201250, rating: 4.5, phone: "(615) 555-0104" },
            { name: "Hillsboro Homes", permits: 3, avgCost: 261667, rating: 4.9, phone: "(615) 555-0105" },
            { name: "Germantown Builders", permits: 3, avgCost: 246000, rating: 4.7, phone: "(615) 555-0106" },
        ];

        // ============================================================
        // CONFIG & STATE
        // ============================================================
        const CONFIG = {
            defaultCenter: [36.1627, -86.7816],
            defaultZoom: 12,
            propertyZoom: 17,
            searchRadiusMiles: 1,
            tax: { assessmentRatio: 0.25, taxRate: 3.254 },
            apis: {
                geocode: 'https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates',
                parcels: 'https://services2.arcgis.com/HdTo6HJqh92wn4D8/ArcGIS/rest/services/Parcels_with_Building_Characteristics_view/FeatureServer/0',
                buildings: 'https://maps.nashville.gov/arcgis/rest/services/Planimetric/Buildings/MapServer/0',
                zoning: 'https://maps.nashville.gov/arcgis/rest/services/Zoning_Landuse/BaseZoning/MapServer/0',
                usdBoundary: 'https://maps.nashville.gov/arcgis/rest/services/Boundaries/USD_GSD/MapServer/0',
            }
        };

        let map, parcelLayer, buildingLayers = [], permitMarkers = [];
        let currentProperty = { appraisedValue: 0, lotArea: 0 };
        let nearbyPermits = [];
        let isSatellite = false, showPermitsOnMap = true;
        let streetLayer, satelliteLayer;

        // ============================================================
        // MAP INITIALIZATION
        // ============================================================
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView(CONFIG.defaultCenter, CONFIG.defaultZoom);
            
            streetLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap © CARTO',
                maxZoom: 20
            }).addTo(map);

            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19
            });

            // Load contractors
            renderContractors();
        }

        // ============================================================
        // TAB SWITCHING
        // ============================================================
        function switchTab(tabName) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // ============================================================
        // ADDRESS SEARCH
        // ============================================================
        async function searchAddress(address) {
            if (!address.trim()) return;
            showLoading('Searching...');

            try {
                const url = `${CONFIG.apis.geocode}?f=json&singleLine=${encodeURIComponent(address + ', Nashville, TN')}&outFields=*&maxLocations=1`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.candidates?.length) {
                    hideLoading();
                    alert('Address not found');
                    return;
                }

                const loc = data.candidates[0].location;
                currentProperty.lat = loc.y;
                currentProperty.lon = loc.x;
                currentProperty.address = data.candidates[0].address;

                map.setView([loc.y, loc.x], CONFIG.propertyZoom);
                await queryParcel(loc.x, loc.y);
                findNearbyPermits(loc.y, loc.x);
                document.getElementById('mapLegend').style.display = 'block';
                hideLoading();

            } catch (err) {
                console.error(err);
                hideLoading();
                alert('Search error');
            }
        }

        // ============================================================
        // PARCEL QUERY
        // ============================================================
        async function queryParcel(lon, lat) {
            showLoading('Loading parcel...');

            try {
                const url = `${CONFIG.apis.parcels}/query?` + new URLSearchParams({
                    f: 'geojson',
                    geometry: JSON.stringify({ x: lon, y: lat, spatialReference: { wkid: 4326 } }),
                    geometryType: 'esriGeometryPoint',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: '*',
                    returnGeometry: true
                });

                const response = await fetch(url);
                const data = await response.json();

                if (data.features?.length) {
                    const parcel = data.features[0];
                    Object.assign(currentProperty, parcel.properties);
                    currentProperty.geometry = parcel.geometry;
                    drawParcel(parcel);
                    await queryBuildings(parcel.geometry);
                    await queryZoning(lon, lat);
                    await queryDistrict(lon, lat);
                }

                updatePropertyUI();
                updateTaxEstimates();

            } catch (err) {
                console.error(err);
            }
        }

        function drawParcel(parcel) {
            if (parcelLayer) map.removeLayer(parcelLayer);
            parcelLayer = L.geoJSON(parcel, {
                style: { color: '#2c3e50', weight: 3, fillColor: '#6b8fa3', fillOpacity: 0.15, dashArray: '5,5' }
            }).addTo(map);
        }

        async function queryBuildings(geometry) {
            buildingLayers.forEach(l => map.removeLayer(l));
            buildingLayers = [];

            try {
                const coords = geometry.coordinates[0];
                let [minX, minY, maxX, maxY] = [Infinity, Infinity, -Infinity, -Infinity];
                coords.forEach(c => { minX = Math.min(minX, c[0]); minY = Math.min(minY, c[1]); maxX = Math.max(maxX, c[0]); maxY = Math.max(maxY, c[1]); });

                const url = `${CONFIG.apis.buildings}/query?` + new URLSearchParams({
                    f: 'geojson',
                    geometry: JSON.stringify({ xmin: minX, ymin: minY, xmax: maxX, ymax: maxY, spatialReference: { wkid: 4326 } }),
                    geometryType: 'esriGeometryEnvelope',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: '*',
                    returnGeometry: true,
                    outSR: 4326
                });

                const response = await fetch(url);
                const data = await response.json();

                data.features?.forEach(b => {
                    const layer = L.geoJSON(b, {
                        style: { color: '#2c3e50', weight: 2, fillColor: '#2c3e50', fillOpacity: 0.4 }
                    }).addTo(map);
                    buildingLayers.push(layer);
                });

            } catch (err) {
                console.error(err);
            }
        }

        async function queryZoning(lon, lat) {
            try {
                const url = `${CONFIG.apis.zoning}/query?` + new URLSearchParams({
                    f: 'json',
                    geometry: JSON.stringify({ x: lon, y: lat, spatialReference: { wkid: 4326 } }),
                    geometryType: 'esriGeometryPoint',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: '*',
                    returnGeometry: false
                });
                const response = await fetch(url);
                const data = await response.json();
                if (data.features?.length) {
                    const z = data.features[0].attributes;
                    currentProperty.zoning = z.ZONE_DESC || z.ZONE_TYPE || 'Unknown';
                    currentProperty.zoningCode = z.ZONE_CODE || z.ZONE_TYPE || '';
                }
            } catch (err) { console.error(err); }
        }

        async function queryDistrict(lon, lat) {
            try {
                const url = `${CONFIG.apis.usdBoundary}/query?` + new URLSearchParams({
                    f: 'json',
                    geometry: JSON.stringify({ x: lon, y: lat, spatialReference: { wkid: 4326 } }),
                    geometryType: 'esriGeometryPoint',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: '*',
                    returnGeometry: false
                });
                const response = await fetch(url);
                const data = await response.json();
                currentProperty.inUSD = data.features?.length > 0;
                currentProperty.serviceDistrict = currentProperty.inUSD ? 'USD' : 'GSD';
            } catch (err) { console.error(err); }
        }

        // ============================================================
        // NEARBY PERMITS
        // ============================================================
        function findNearbyPermits(lat, lon) {
            const radiusMiles = CONFIG.searchRadiusMiles;
            
            nearbyPermits = SAMPLE_PERMITS.map(p => {
                const dist = haversineDistance(lat, lon, p.lat, p.lon);
                return { ...p, distance: dist };
            }).filter(p => p.distance <= radiusMiles)
              .sort((a, b) => a.distance - b.distance);

            // Update stats
            document.getElementById('nearbyCount').textContent = nearbyPermits.length;
            
            if (nearbyPermits.length > 0) {
                const avgCost = nearbyPermits.reduce((sum, p) => sum + p.cost, 0) / nearbyPermits.length;
                const avgSize = nearbyPermits.reduce((sum, p) => sum + p.sqft, 0) / nearbyPermits.length;
                document.getElementById('avgCost').textContent = '$' + Math.round(avgCost / 1000) + 'K';
                document.getElementById('avgSize').textContent = Math.round(avgSize);
            }

            renderPermitList();
            renderPermitMarkers();
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function renderPermitList() {
            const container = document.getElementById('permitList');
            
            if (nearbyPermits.length === 0) {
                container.innerHTML = `<div style="text-align:center;padding:40px 20px;color:#888;">No DADU permits found within 1 mile</div>`;
                return;
            }

            container.innerHTML = nearbyPermits.slice(0, 10).map((p, i) => `
                <div class="permit-card" onclick="focusPermit(${i})">
                    <div class="permit-header">
                        <div class="permit-address">${p.address}</div>
                        <div class="permit-distance">${p.distance.toFixed(2)} mi</div>
                    </div>
                    <div class="permit-details">
                        <div class="permit-detail"><strong>$${(p.cost/1000).toFixed(0)}K</strong></div>
                        <div class="permit-detail"><strong>${p.sqft}</strong> sqft</div>
                        <div class="permit-detail">${p.date.slice(0,7)}</div>
                    </div>
                    <div class="permit-contractor">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        ${p.contractor}
                    </div>
                </div>
            `).join('');
        }

        function renderPermitMarkers() {
            // Clear existing
            permitMarkers.forEach(m => map.removeLayer(m));
            permitMarkers = [];

            if (!showPermitsOnMap) return;

            nearbyPermits.forEach((p, i) => {
                const marker = L.circleMarker([p.lat, p.lon], {
                    radius: 8,
                    fillColor: '#6b8e4e',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.9
                }).addTo(map);

                marker.bindPopup(`
                    <div style="font-family:Montserrat,sans-serif;">
                        <strong>${p.address}</strong><br>
                        <span style="color:#6b8e4e;font-weight:600;">$${p.cost.toLocaleString()}</span> · ${p.sqft} sqft<br>
                        <span style="color:#666;">${p.contractor}</span>
                    </div>
                `);

                permitMarkers.push(marker);
            });
        }

        function focusPermit(index) {
            const p = nearbyPermits[index];
            map.setView([p.lat, p.lon], 18);
            permitMarkers[index]?.openPopup();

            // Highlight card
            document.querySelectorAll('.permit-card').forEach((c, i) => {
                c.classList.toggle('active', i === index);
            });
        }

        // ============================================================
        // CONTRACTORS
        // ============================================================
        function renderContractors() {
            const container = document.getElementById('contractorList');
            container.innerHTML = CONTRACTORS.map((c, i) => `
                <div class="contractor-card">
                    <div class="contractor-rank ${i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}">${i + 1}</div>
                    <div class="contractor-info">
                        <div class="contractor-name">${c.name}</div>
                        <div class="contractor-stats">
                            <span><strong>${c.permits}</strong> DADUs</span>
                            <span>Avg <strong>$${Math.round(c.avgCost/1000)}K</strong></span>
                            <span>★ ${c.rating}</span>
                        </div>
                    </div>
                    <svg class="contractor-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </div>
            `).join('');
        }

        // ============================================================
        // UI UPDATES
        // ============================================================
        function updatePropertyUI() {
            document.getElementById('propAddress').textContent = currentProperty.address || '-';
            
            const lotArea = currentProperty.LANDAREA || currentProperty.LotSize || (currentProperty.ACREAGE ? currentProperty.ACREAGE * 43560 : 0);
            currentProperty.lotArea = Math.round(lotArea);
            document.getElementById('propLotArea').textContent = lotArea > 0 ? Math.round(lotArea).toLocaleString() + ' sqft' : '-';

            document.getElementById('propAPN').textContent = currentProperty.APN || currentProperty.STANPAR || '-';
            document.getElementById('propZoning').textContent = currentProperty.zoning || '-';
            document.getElementById('propDistrict').textContent = currentProperty.serviceDistrict || '-';

            const appraised = currentProperty.APPRAISAL || currentProperty.TOTAL_APPR || currentProperty.TOTALVALUE || 0;
            currentProperty.appraisedValue = appraised;
            document.getElementById('propAppraisedValue').textContent = appraised > 0 ? '$' + appraised.toLocaleString() : '-';

            const maxDADU = currentProperty.lotArea >= 10000 ? 850 : 700;
            document.getElementById('propMaxDADU').textContent = maxDADU + ' sqft';

            // Eligibility
            const banner = document.getElementById('eligibilityBanner');
            const text = document.getElementById('eligibilityText');
            const isRorRS = /^(R|RS)/i.test(currentProperty.zoningCode || '');
            
            if (isRorRS && currentProperty.inUSD) {
                banner.className = 'eligibility-banner eligible';
                text.innerHTML = '✓ Nashville law allows a DADU here';
            } else if (!currentProperty.inUSD) {
                banner.className = 'eligibility-banner not-eligible';
                text.innerHTML = '✗ Property is in General Services District';
            } else {
                banner.className = 'eligibility-banner checking';
                text.innerHTML = '⚠ Verify zoning permits DADUs';
            }
        }

        // ============================================================
        // TAX CALCULATOR
        // ============================================================
        function updateTaxEstimates() {
            const currentValue = currentProperty.appraisedValue || 0;
            const constructionCost = parseInt(document.getElementById('constructionCostSlider').value) || 200000;
            const projectedValue = currentValue + constructionCost;

            const currentTax = (currentValue * 0.25 / 100) * 3.254;
            const projectedTax = (projectedValue * 0.25 / 100) * 3.254;
            const increase = projectedTax - currentTax;

            document.getElementById('taxIncrease').textContent = '+$' + Math.round(increase).toLocaleString();
            document.getElementById('currentTax').textContent = '$' + Math.round(currentTax).toLocaleString();
            document.getElementById('projectedTax').textContent = '$' + Math.round(projectedTax).toLocaleString();

            return increase;
        }

        // ============================================================
        // ROI CALCULATOR
        // ============================================================
        function calculateROI() {
            const cost = parseInt(document.getElementById('roiConstructionCost').value) || 200000;
            const rent = parseInt(document.getElementById('roiMonthlyRent').value) || 1400;
            const vacancy = (parseInt(document.getElementById('roiVacancyRate').value) || 5) / 100;
            const opCosts = parseInt(document.getElementById('roiOperatingCosts').value) || 2400;
            const taxIncrease = updateTaxEstimates();

            const grossRent = rent * 12;
            const effectiveRent = grossRent * (1 - vacancy);
            const noi = effectiveRent - opCosts - taxIncrease;
            const cashReturn = (noi / cost) * 100;
            const breakEven = cost / noi;

            document.getElementById('roiNOI').textContent = '$' + Math.round(noi).toLocaleString();
            document.getElementById('roiCashReturn').textContent = cashReturn.toFixed(2) + '%';
            document.getElementById('roiBreakEven').textContent = breakEven.toFixed(1) + ' years';
        }

        // ============================================================
        // MAP TOOLS
        // ============================================================
        function toggleSatellite() {
            const tool = document.getElementById('satelliteTool');
            if (isSatellite) {
                map.removeLayer(satelliteLayer);
                streetLayer.addTo(map);
                tool.classList.remove('active');
            } else {
                map.removeLayer(streetLayer);
                satelliteLayer.addTo(map);
                tool.classList.add('active');
            }
            isSatellite = !isSatellite;
        }

        function togglePermits() {
            showPermitsOnMap = !showPermitsOnMap;
            document.getElementById('permitsTool').classList.toggle('active', showPermitsOnMap);
            renderPermitMarkers();
        }

        function toggleTool(name) {
            document.getElementById(name + 'Tool').classList.toggle('active');
            alert(name.charAt(0).toUpperCase() + name.slice(1) + ' tool coming soon!');
        }

        // ============================================================
        // UTILITIES
        // ============================================================
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function openEditModal() {
            alert('Edit modal coming soon!');
        }

        // ============================================================
        // EVENT LISTENERS
        // ============================================================
        document.getElementById('addressSearch').addEventListener('keypress', e => {
            if (e.key === 'Enter') searchAddress(e.target.value);
        });

        document.getElementById('constructionCostSlider').addEventListener('input', function() {
            document.getElementById('constructionCostDisplay').textContent = '$' + parseInt(this.value).toLocaleString();
            updateTaxEstimates();
            calculateROI();
        });

        ['roiConstructionCost', 'roiMonthlyRent', 'roiVacancyRate', 'roiOperatingCosts'].forEach(id => {
            document.getElementById(id).addEventListener('change', calculateROI);
        });

        // ============================================================
        // INIT
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            calculateROI();
        });
    </script>
</body>
</html>
