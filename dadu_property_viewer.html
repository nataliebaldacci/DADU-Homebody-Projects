<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property | Homebody Projects</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f5f5f0;
            color: #333;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: #6b8e4e;
        }

        .logo span {
            color: #2c3e50;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: #f5f5f0;
            border-radius: 8px;
            padding: 8px 16px;
            width: 400px;
            gap: 8px;
        }

        .search-bar svg {
            width: 18px;
            height: 18px;
            color: #888;
            flex-shrink: 0;
        }

        .search-bar input {
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
        }

        .nav-tab {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            text-decoration: none;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            background: #f0f0f0;
            color: #333;
        }

        .nav-tab.active {
            background: #6b8e4e;
            color: white;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #6b8fa3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            margin-top: 60px;
            height: calc(100vh - 60px);
        }

        /* Left Sidebar */
        .sidebar {
            width: 380px;
            background: #fff;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        /* Eligibility Banner */
        .eligibility-banner {
            padding: 20px;
            background: #e8f5e9;
            border-bottom: 1px solid #c8e6c9;
        }

        .eligibility-banner.eligible {
            background: #e8f5e9;
            border-color: #c8e6c9;
        }

        .eligibility-banner.not-eligible {
            background: #ffebee;
            border-color: #ffcdd2;
        }

        .eligibility-banner.checking {
            background: #fff3e0;
            border-color: #ffe0b2;
        }

        .eligibility-text {
            font-size: 16px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .eligibility-banner.not-eligible .eligibility-text {
            color: #c62828;
        }

        .eligibility-banner.checking .eligibility-text {
            color: #ef6c00;
        }

        .eligibility-note {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }

        .eligibility-note svg {
            width: 16px;
            height: 16px;
            color: #ffc107;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .assumption-link {
            color: #6b8fa3;
            text-decoration: none;
        }

        .assumption-link:hover {
            text-decoration: underline;
        }

        /* Action Buttons */
        .action-buttons {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .btn-row {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-outline {
            background: #fff;
            border: 2px solid #e0e0e0;
            color: #333;
        }

        .btn-outline:hover {
            border-color: #6b8fa3;
            color: #6b8fa3;
        }

        .btn-primary {
            background: #6b8fa3;
            border: 2px solid #6b8fa3;
            color: white;
        }

        .btn-primary:hover {
            background: #5a7d91;
            border-color: #5a7d91;
        }

        .btn-green {
            background: #6b8e4e;
            border: 2px solid #6b8e4e;
            color: white;
        }

        .btn-green:hover {
            background: #5a7a3f;
            border-color: #5a7a3f;
        }

        /* Property Information */
        .property-section {
            padding: 20px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        .edit-btn {
            padding: 6px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fff;
            font-family: inherit;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-btn:hover {
            border-color: #6b8fa3;
            color: #6b8fa3;
        }

        .data-disclaimer {
            font-size: 12px;
            color: #888;
            margin-bottom: 16px;
            font-style: italic;
        }

        .property-row {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .property-row:last-child {
            border-bottom: none;
        }

        .property-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .property-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .property-value.highlight {
            color: #6b8e4e;
        }

        .property-value.warning {
            color: #ef6c00;
        }

        /* Footer Links */
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 16px;
        }

        .footer-link {
            font-size: 13px;
            color: #6b8fa3;
            text-decoration: none;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Map Tools */
        .map-tools {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            display: flex;
            gap: 4px;
            padding: 6px;
            z-index: 500;
        }

        .map-tool {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            gap: 4px;
        }

        .map-tool:hover {
            background: #f5f5f0;
        }

        .map-tool.active {
            background: #e8f5e9;
        }

        .map-tool svg {
            width: 20px;
            height: 20px;
            color: #666;
        }

        .map-tool.active svg {
            color: #6b8e4e;
        }

        .map-tool span {
            font-size: 11px;
            color: #666;
        }

        /* Map Notice */
        .map-notice {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            border-radius: 8px;
            padding: 12px 16px;
            max-width: 280px;
            z-index: 500;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .map-notice.hidden {
            display: none;
        }

        .map-notice svg {
            width: 20px;
            height: 20px;
            color: #ef6c00;
            flex-shrink: 0;
        }

        .map-notice p {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .map-notice .close-notice {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
            font-size: 16px;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 500;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #666;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: #f5f5f0;
            border-color: #ccc;
        }

        /* Edit Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #fff;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 24px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #6b8fa3;
        }

        .input-with-unit {
            position: relative;
        }

        .input-with-unit input {
            padding-right: 50px;
        }

        .input-unit {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 14px;
        }

        .reset-link {
            color: #6b8fa3;
            font-size: 13px;
            text-decoration: none;
            cursor: pointer;
        }

        .reset-link:hover {
            text-decoration: underline;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: #fff;
            border: 1px solid #e0e0e0;
            color: #666;
        }

        .modal-btn-cancel:hover {
            background: #f5f5f0;
        }

        .modal-btn-save {
            background: #2c3e50;
            border: 1px solid #2c3e50;
            color: white;
        }

        .modal-btn-save:hover {
            background: #1a252f;
        }

        /* Loading State */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 600;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: #6b8e4e;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: #666;
        }

        /* Custom Leaflet Styles */
        .leaflet-container {
            font-family: 'Montserrat', sans-serif;
        }

        .building-popup {
            font-size: 13px;
        }

        .building-popup strong {
            color: #2c3e50;
        }
    </style>
</head>
<body>
<!-- Homebody Navigation -->
<div id="homebody-nav" style="background:#1e2a38;padding:0 20px;font-family:Montserrat,sans-serif;position:sticky;top:0;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.3);"><div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:56px;"><a href="index.html" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:white;"><div style="width:32px;height:32px;background:#4a9;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px;">üè†</div><span style="font-weight:700;font-size:16px;">Homebody Projects</span></a><div style="display:flex;gap:6px;"><a href="am_i_eligible.html" style="color:rgba(255,255,255,0.85);text-decoration:none;padding:8px 12px;font-size:12px;font-weight:500;">Eligibility</a><a href="dadu_opportunity_explorer_v2.html" style="color:rgba(255,255,255,0.85);text-decoration:none;padding:8px 12px;font-size:12px;font-weight:500;">Explorer</a><a href="nashville_permit_explorer_v3.html" style="color:rgba(255,255,255,0.85);text-decoration:none;padding:8px 12px;font-size:12px;font-weight:500;">Permits</a><a href="dadu_code_legislation_v3.html" style="color:rgba(255,255,255,0.85);text-decoration:none;padding:8px 12px;font-size:12px;font-weight:500;">Code</a></div></div></div>

    <!-- Header -->
    <header class="header">
        <div class="logo">Homebody<span>Projects</span></div>
        
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="addressSearch" placeholder="Enter Nashville address...">
        </div>

        <nav class="nav-tabs">
            <a href="#" class="nav-tab active">Property</a>
            <a href="#" class="nav-tab">Designs</a>
            <a href="#" class="nav-tab">Sketch</a>
            <a href="#" class="nav-tab">DADU Report</a>
        </nav>

        <div class="user-avatar">NB</div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <!-- Eligibility Banner -->
            <div class="eligibility-banner checking" id="eligibilityBanner">
                <div class="eligibility-text" id="eligibilityText">
                    Enter an address to check DADU eligibility
                </div>
                <div class="eligibility-note">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span>We're assuming there's a single-family home on this property. <a href="#" class="assumption-link" onclick="openEditModal(); return false;">If not, click here.</a></span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <div class="btn-row">
                    <button class="btn btn-outline">Browse Designs</button>
                    <button class="btn btn-primary">Sketch a DADU</button>
                </div>
                <button class="btn btn-green">DADU Report</button>
            </div>

            <!-- Property Information -->
            <div class="property-section">
                <div class="section-header">
                    <h2 class="section-title">Property Information</h2>
                    <button class="edit-btn" onclick="openEditModal()">Edit</button>
                </div>
                <p class="data-disclaimer">Information based on best available data. Please confirm accuracy.</p>

                <div class="property-row">
                    <div class="property-label">Address</div>
                    <div class="property-value" id="propAddress">-</div>
                </div>

                <div class="property-row">
                    <div class="property-label">Lot Area</div>
                    <div class="property-value" id="propLotArea">-</div>
                </div>

                <div class="property-row">
                    <div class="property-label">Residence on Property</div>
                    <div class="property-value" id="propResidence">Single-family</div>
                </div>

                <div class="property-row">
                    <div class="property-label">Area of Primary Residence</div>
                    <div class="property-value" id="propPrimaryArea">-</div>
                </div>

                <div class="property-row">
                    <div class="property-label">Area of Other Structures</div>
                    <div class="property-value" id="propOtherArea">0 sqft</div>
                </div>

                <div class="property-row">
                    <div class="property-label">Parcel Number (APN)</div>
                    <div class="property-value" id="propAPN">-</div>
                </div>

                <div class="property-row">
                    <div class="property-label">Zoning</div>
                    <div class="property-value" id="propZoning">-</div>
                </div>

                <div class="property-row">
                    <div class="property-label">Service District</div>
                    <div class="property-value" id="propDistrict">-</div>
                </div>

                <div class="property-row">
                    <div class="property-label">Max DADU Size</div>
                    <div class="property-value highlight" id="propMaxDADU">-</div>
                </div>
            </div>

            <!-- Footer -->
            <div class="sidebar-footer">
                <a href="#" class="footer-link">Send Feedback</a>
                <a href="#" class="footer-link">Help</a>
            </div>
        </aside>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>

            <!-- Loading Overlay -->
            <div class="loading-overlay hidden" id="loadingOverlay">
                <div class="spinner"></div>
                <div class="loading-text" id="loadingText">Loading property data...</div>
            </div>

            <!-- Map Notice -->
            <div class="map-notice" id="mapNotice">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <div>
                    <p>Building footprints shown may not be current. Please verify with your own measurements.</p>
                    <button class="close-notice" onclick="closeNotice()">√ó</button>
                </div>
            </div>

            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="map.zoomIn()">+</button>
                <button class="zoom-btn" onclick="map.zoomOut()">‚àí</button>
            </div>

            <!-- Map Tools -->
            <div class="map-tools">
                <button class="map-tool" onclick="toggleEditMode()" id="editBuildingTool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    <span>Edit Building</span>
                </button>
                <button class="map-tool" onclick="toggleMeasure()" id="measureTool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 12h20"></path>
                        <path d="M6 8v8"></path>
                        <path d="M18 8v8"></path>
                    </svg>
                    <span>Measure</span>
                </button>
                <button class="map-tool" onclick="toggleDimensions()" id="dimensionsTool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="3" x2="9" y2="21"></line>
                        <line x1="15" y1="3" x2="15" y2="21"></line>
                    </svg>
                    <span>Dimensions</span>
                </button>
                <button class="map-tool" onclick="toggleSatellite()" id="satelliteTool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    <span>Satellite</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Property Information</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Residence on Property</label>
                    <select class="form-select" id="editResidence">
                        <option value="single-family">Single-family</option>
                        <option value="multi-family">Multi-family</option>
                        <option value="vacant">Vacant lot</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Area of Primary Residence</label>
                    <div class="input-with-unit">
                        <input type="number" class="form-input" id="editPrimaryArea" placeholder="0">
                        <span class="input-unit">sqft</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Area of Other Structures</label>
                    <div class="input-with-unit">
                        <input type="number" class="form-input" id="editOtherArea" placeholder="0">
                        <span class="input-unit">sqft</span>
                    </div>
                </div>
                <a href="#" class="reset-link" onclick="resetPropertyInfo(); return false;">Reset Property Information</a>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn modal-btn-save" onclick="savePropertyInfo()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const CONFIG = {
            defaultCenter: [36.1627, -86.7816], // Nashville
            defaultZoom: 12,
            propertyZoom: 18,
            
            // Nashville API Endpoints
            apis: {
                geocode: 'https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates',
                parcels: 'https://services2.arcgis.com/HdTo6HJqh92wn4D8/ArcGIS/rest/services/Parcels_with_Building_Characteristics_view/FeatureServer/0',
                buildings: 'https://maps.nashville.gov/arcgis/rest/services/Planimetric/Buildings/MapServer/0',
                zoning: 'https://maps.nashville.gov/arcgis/rest/services/Zoning_Landuse/BaseZoning/MapServer/0',
                usdBoundary: 'https://maps.nashville.gov/arcgis/rest/services/Boundaries/USD_GSD/MapServer/0',
                overlay: 'https://maps.nashville.gov/arcgis/rest/services/Zoning_Landuse/Zoning_Overlay_Districts/MapServer/0'
            },

            // Lot size threshold for larger DADUs
            largeLotThreshold: 10000,
            
            // DADU size limits
            daduLimits: {
                small: { living: 700, footprint: 750 },
                large: { living: 850, footprint: 1000 }
            }
        };

        // ============================================================
        // STATE
        // ============================================================
        let map;
        let parcelLayer = null;
        let buildingLayers = [];
        let currentProperty = null;
        let isSatellite = false;
        let streetLayer, satelliteLayer;

        // ============================================================
        // INITIALIZE MAP
        // ============================================================
        function initMap() {
            map = L.map('map', {
                zoomControl: false
            }).setView(CONFIG.defaultCenter, CONFIG.defaultZoom);

            // Street layer (default)
            streetLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                maxZoom: 20
            }).addTo(map);

            // Satellite layer
            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri',
                maxZoom: 19
            });
        }

        // ============================================================
        // ADDRESS SEARCH
        // ============================================================
        async function searchAddress(address) {
            if (!address.trim()) return;

            showLoading('Searching for address...');

            try {
                // Step 1: Geocode address
                const geocodeUrl = `${CONFIG.apis.geocode}?f=json&singleLine=${encodeURIComponent(address + ', Nashville, TN')}&outFields=*&maxLocations=1`;
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();

                if (!geocodeData.candidates || geocodeData.candidates.length === 0) {
                    hideLoading();
                    alert('Address not found. Please try another Nashville address.');
                    return;
                }

                const location = geocodeData.candidates[0].location;
                const foundAddress = geocodeData.candidates[0].address;

                // Center map on location
                map.setView([location.y, location.x], CONFIG.propertyZoom);

                // Step 2: Query parcel at location
                await queryParcelAtLocation(location.x, location.y, foundAddress);

            } catch (error) {
                console.error('Search error:', error);
                hideLoading();
                alert('Error searching address. Please try again.');
            }
        }

        // ============================================================
        // QUERY PARCEL DATA
        // ============================================================
        async function queryParcelAtLocation(lon, lat, address) {
            showLoading('Loading parcel data...');

            try {
                // Query parcel
                const parcelUrl = `${CONFIG.apis.parcels}/query?` + new URLSearchParams({
                    f: 'geojson',
                    geometry: JSON.stringify({ x: lon, y: lat, spatialReference: { wkid: 4326 } }),
                    geometryType: 'esriGeometryPoint',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: '*',
                    returnGeometry: true
                });

                const parcelResponse = await fetch(parcelUrl);
                const parcelData = await parcelResponse.json();

                if (!parcelData.features || parcelData.features.length === 0) {
                    hideLoading();
                    updateUINoParcel(address);
                    return;
                }

                const parcel = parcelData.features[0];
                currentProperty = {
                    address: address,
                    geometry: parcel.geometry,
                    ...parcel.properties
                };

                // Draw parcel on map
                drawParcel(parcel);

                // Query building footprints
                await queryBuildingFootprints(parcel.geometry);

                // Query zoning
                await queryZoning(lon, lat);

                // Query USD/GSD
                await queryServiceDistrict(lon, lat);

                // Update UI
                updatePropertyUI();

                hideLoading();

            } catch (error) {
                console.error('Parcel query error:', error);
                hideLoading();
            }
        }

        // ============================================================
        // DRAW PARCEL
        // ============================================================
        function drawParcel(parcel) {
            // Clear existing
            if (parcelLayer) {
                map.removeLayer(parcelLayer);
            }

            parcelLayer = L.geoJSON(parcel, {
                style: {
                    color: '#2c3e50',
                    weight: 3,
                    fillColor: '#6b8fa3',
                    fillOpacity: 0.1,
                    dashArray: '5, 5'
                }
            }).addTo(map);

            // Fit map to parcel bounds
            map.fitBounds(parcelLayer.getBounds(), { padding: [50, 50] });
        }

        // ============================================================
        // QUERY BUILDING FOOTPRINTS
        // ============================================================
        async function queryBuildingFootprints(parcelGeometry) {
            showLoading('Loading building footprints...');

            // Clear existing buildings
            buildingLayers.forEach(layer => map.removeLayer(layer));
            buildingLayers = [];

            try {
                // Get bounding box of parcel
                const coords = parcelGeometry.coordinates[0];
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                
                coords.forEach(coord => {
                    minX = Math.min(minX, coord[0]);
                    minY = Math.min(minY, coord[1]);
                    maxX = Math.max(maxX, coord[0]);
                    maxY = Math.max(maxY, coord[1]);
                });

                // Query buildings within bbox
                const buildingUrl = `${CONFIG.apis.buildings}/query?` + new URLSearchParams({
                    f: 'geojson',
                    geometry: JSON.stringify({
                        xmin: minX, ymin: minY,
                        xmax: maxX, ymax: maxY,
                        spatialReference: { wkid: 4326 }
                    }),
                    geometryType: 'esriGeometryEnvelope',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: '*',
                    returnGeometry: true,
                    outSR: 4326
                });

                const buildingResponse = await fetch(buildingUrl);
                const buildingData = await buildingResponse.json();

                if (buildingData.features && buildingData.features.length > 0) {
                    // Calculate total building area
                    let totalBuildingArea = 0;
                    
                    buildingData.features.forEach(building => {
                        const layer = L.geoJSON(building, {
                            style: {
                                color: '#2c3e50',
                                weight: 2,
                                fillColor: '#2c3e50',
                                fillOpacity: 0.4
                            }
                        }).addTo(map);

                        // Add popup with area if available
                        const area = building.properties.SHAPE_Area || building.properties.Shape__Area;
                        if (area) {
                            const sqft = Math.round(area);
                            totalBuildingArea += sqft;
                            layer.bindPopup(`<div class="building-popup"><strong>Building</strong><br>Area: ${sqft.toLocaleString()} sqft</div>`);
                        }

                        buildingLayers.push(layer);
                    });

                    // Update property info with building area
                    if (totalBuildingArea > 0) {
                        currentProperty.primaryArea = totalBuildingArea;
                        document.getElementById('propPrimaryArea').textContent = totalBuildingArea.toLocaleString() + ' sqft';
                    }

                    // Hide the "no buildings" notice
                    document.getElementById('mapNotice').classList.add('hidden');
                } else {
                    // Show notice that no buildings detected
                    document.getElementById('mapNotice').classList.remove('hidden');
                }

            } catch (error) {
                console.error('Building query error:', error);
                document.getElementById('mapNotice').classList.remove('hidden');
            }
        }

        // ============================================================
        // QUERY ZONING
        // ============================================================
        async function queryZoning(lon, lat) {
            try {
                const zoningUrl = `${CONFIG.apis.zoning}/query?` + new URLSearchParams({
                    f: 'json',
                    geometry: JSON.stringify({ x: lon, y: lat, spatialReference: { wkid: 4326 } }),
                    geometryType: 'esriGeometryPoint',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: '*',
                    returnGeometry: false
                });

                const response = await fetch(zoningUrl);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const zoning = data.features[0].attributes;
                    currentProperty.zoning = zoning.ZONE_DESC || zoning.ZONE_TYPE || zoning.ZONING || 'Unknown';
                    currentProperty.zoningCode = zoning.ZONE_CODE || zoning.ZONE_TYPE || '';
                }
            } catch (error) {
                console.error('Zoning query error:', error);
            }
        }

        // ============================================================
        // QUERY SERVICE DISTRICT (USD/GSD)
        // ============================================================
        async function queryServiceDistrict(lon, lat) {
            try {
                const districtUrl = `${CONFIG.apis.usdBoundary}/query?` + new URLSearchParams({
                    f: 'json',
                    geometry: JSON.stringify({ x: lon, y: lat, spatialReference: { wkid: 4326 } }),
                    geometryType: 'esriGeometryPoint',
                    spatialRel: 'esriSpatialRelIntersects',
                    outFields: '*',
                    returnGeometry: false
                });

                const response = await fetch(districtUrl);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const district = data.features[0].attributes;
                    currentProperty.serviceDistrict = district.DISTRICT || district.NAME || 'USD';
                    currentProperty.inUSD = true;
                } else {
                    currentProperty.serviceDistrict = 'GSD';
                    currentProperty.inUSD = false;
                }
            } catch (error) {
                console.error('District query error:', error);
                currentProperty.serviceDistrict = 'Unknown';
            }
        }

        // ============================================================
        // UPDATE UI
        // ============================================================
        function updatePropertyUI() {
            if (!currentProperty) return;

            // Address
            document.getElementById('propAddress').textContent = currentProperty.address || '-';

            // Lot Area
            const lotArea = currentProperty.LANDAREA || currentProperty.LotSize || currentProperty.ACREAGE * 43560 || 0;
            currentProperty.lotArea = Math.round(lotArea);
            document.getElementById('propLotArea').textContent = lotArea > 0 ? Math.round(lotArea).toLocaleString() + ' sqft' : '-';

            // APN
            const apn = currentProperty.APN || currentProperty.STANPAR || currentProperty.PARCELID || '-';
            document.getElementById('propAPN').textContent = apn;

            // Zoning
            document.getElementById('propZoning').textContent = currentProperty.zoning || '-';

            // Service District
            document.getElementById('propDistrict').textContent = currentProperty.serviceDistrict || '-';

            // Primary Area
            if (currentProperty.primaryArea) {
                document.getElementById('propPrimaryArea').textContent = currentProperty.primaryArea.toLocaleString() + ' sqft';
            }

            // Calculate Max DADU Size
            const isLargeLot = currentProperty.lotArea >= CONFIG.largeLotThreshold;
            const maxDADU = isLargeLot ? CONFIG.daduLimits.large.living : CONFIG.daduLimits.small.living;
            document.getElementById('propMaxDADU').textContent = maxDADU + ' sqft';

            // Update eligibility banner
            updateEligibilityBanner();
        }

        function updateEligibilityBanner() {
            const banner = document.getElementById('eligibilityBanner');
            const text = document.getElementById('eligibilityText');

            // Check eligibility
            const zoning = currentProperty.zoningCode || currentProperty.zoning || '';
            const isRorRS = /^(R|RS)/i.test(zoning);
            const inUSD = currentProperty.inUSD;

            if (isRorRS && inUSD) {
                banner.className = 'eligibility-banner eligible';
                text.innerHTML = '‚úì Nashville law allows a DADU here. <br><small style="font-weight:400">Based on BL2025-1007, effective December 12, 2025</small>';
            } else if (!inUSD) {
                banner.className = 'eligibility-banner not-eligible';
                text.innerHTML = '‚úó This property is in the General Services District. <br><small style="font-weight:400">DADU requires overlay district or SP zoning.</small>';
            } else {
                banner.className = 'eligibility-banner not-eligible';
                text.innerHTML = '‚úó Zoning may not permit DADUs. <br><small style="font-weight:400">Contact Metro Planning for verification.</small>';
            }
        }

        function updateUINoParcel(address) {
            document.getElementById('propAddress').textContent = address || '-';
            document.getElementById('eligibilityBanner').className = 'eligibility-banner checking';
            document.getElementById('eligibilityText').textContent = 'Parcel data not found for this address';
        }

        // ============================================================
        // MODAL FUNCTIONS
        // ============================================================
        function openEditModal() {
            document.getElementById('editModal').classList.add('visible');
            
            // Populate current values
            if (currentProperty) {
                document.getElementById('editPrimaryArea').value = currentProperty.primaryArea || '';
                document.getElementById('editOtherArea').value = currentProperty.otherArea || '';
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('visible');
        }

        function savePropertyInfo() {
            const residence = document.getElementById('editResidence').value;
            const primaryArea = parseInt(document.getElementById('editPrimaryArea').value) || 0;
            const otherArea = parseInt(document.getElementById('editOtherArea').value) || 0;

            document.getElementById('propResidence').textContent = residence.charAt(0).toUpperCase() + residence.slice(1).replace('-', ' ');
            document.getElementById('propPrimaryArea').textContent = primaryArea > 0 ? primaryArea.toLocaleString() + ' sqft' : '0 sqft';
            document.getElementById('propOtherArea').textContent = otherArea > 0 ? otherArea.toLocaleString() + ' sqft' : '0 sqft';

            if (currentProperty) {
                currentProperty.primaryArea = primaryArea;
                currentProperty.otherArea = otherArea;
                currentProperty.residence = residence;
            }

            closeEditModal();
        }

        function resetPropertyInfo() {
            document.getElementById('editPrimaryArea').value = '';
            document.getElementById('editOtherArea').value = '';
            document.getElementById('editResidence').value = 'single-family';
        }

        // ============================================================
        // MAP TOOL FUNCTIONS
        // ============================================================
        function toggleSatellite() {
            const tool = document.getElementById('satelliteTool');
            
            if (isSatellite) {
                map.removeLayer(satelliteLayer);
                streetLayer.addTo(map);
                tool.classList.remove('active');
            } else {
                map.removeLayer(streetLayer);
                satelliteLayer.addTo(map);
                tool.classList.add('active');
            }
            
            isSatellite = !isSatellite;
        }

        function toggleEditMode() {
            const tool = document.getElementById('editBuildingTool');
            tool.classList.toggle('active');
            // TODO: Implement drawing tools
            alert('Building edit mode coming soon! This will allow you to draw/adjust building footprints.');
        }

        function toggleMeasure() {
            const tool = document.getElementById('measureTool');
            tool.classList.toggle('active');
            // TODO: Implement measure tool
            alert('Measure tool coming soon! This will allow you to measure distances on the map.');
        }

        function toggleDimensions() {
            const tool = document.getElementById('dimensionsTool');
            tool.classList.toggle('active');
            // TODO: Toggle dimension labels
        }

        function closeNotice() {
            document.getElementById('mapNotice').classList.add('hidden');
        }

        // ============================================================
        // LOADING OVERLAY
        // ============================================================
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text || 'Loading...';
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // ============================================================
        // EVENT LISTENERS
        // ============================================================
        document.getElementById('addressSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAddress(this.value);
            }
        });

        // Close modal on overlay click
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // ============================================================
        // INITIALIZE
        // ============================================================
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>
