<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nashville Contractor & Permit Analytics | Homebody Projects</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Avenir Next', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #f5f7fa;
            color: #333;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            width: 42px;
            height: 42px;
            background: #6b8e4e;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .logo-text {
            font-size: 22px;
            font-weight: 600;
        }
        .logo-sub {
            font-size: 13px;
            opacity: 0.8;
        }
        .header-nav {
            display: flex;
            gap: 20px;
        }
        .header-nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            opacity: 0.9;
            transition: all 0.2s;
        }
        .header-nav a:hover, .header-nav a.active {
            background: rgba(255,255,255,0.15);
            opacity: 1;
        }
        
        /* Summary Cards */
        .summary-section {
            padding: 25px 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }
        .summary-card {
            background: linear-gradient(135deg, #f8faf8 0%, #fff 100%);
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .summary-card-value {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
        }
        .summary-card-value.green { color: #6b8e4e; }
        .summary-card-value.blue { color: #3498db; }
        .summary-card-value.orange { color: #f39c12; }
        .summary-card-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 25px;
            padding: 25px 30px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Contractor Search Panel */
        .search-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .panel-header {
            padding: 18px 20px;
            background: #fafafa;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-box {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-input:focus {
            border-color: #6b8e4e;
        }
        .search-results {
            max-height: 500px;
            overflow-y: auto;
        }
        .contractor-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.15s;
        }
        .contractor-item:hover {
            background: #f8faf8;
        }
        .contractor-item.selected {
            background: #e8f5e8;
            border-left: 3px solid #6b8e4e;
        }
        .contractor-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 6px;
        }
        .contractor-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #666;
        }
        .contractor-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .contractor-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }
        .badge-gold { background: #fef3cd; color: #856404; }
        .badge-silver { background: #e2e3e5; color: #495057; }
        .badge-bronze { background: #f8d7da; color: #721c24; }
        
        /* Charts Section */
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 20px;
        }
        .chart-card.full-width {
            grid-column: span 2;
        }
        .chart-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-container {
            position: relative;
            height: 280px;
        }
        .chart-container.tall {
            height: 350px;
        }
        
        /* Contractor Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 25px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .modal-subtitle {
            font-size: 13px;
            opacity: 0.8;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 18px;
        }
        .modal-body {
            padding: 25px;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .detail-stat {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .detail-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #6b8e4e;
        }
        .detail-stat-label {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            text-transform: uppercase;
        }
        .detail-section {
            margin-top: 20px;
        }
        .detail-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .permit-type-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .permit-type-tag {
            padding: 6px 12px;
            background: #e8f5e8;
            border-radius: 15px;
            font-size: 12px;
            color: #5a7d3f;
        }
        
        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .leaderboard-rank {
            width: 30px;
            font-weight: 700;
            color: #888;
        }
        .leaderboard-rank.gold { color: #f1c40f; }
        .leaderboard-rank.silver { color: #95a5a6; }
        .leaderboard-rank.bronze { color: #e67e22; }
        .leaderboard-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
        }
        .leaderboard-value {
            font-weight: 600;
            color: #6b8e4e;
        }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 50px;
            color: #888;
        }
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #e0e0e0;
            border-top-color: #6b8e4e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .summary-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
            .chart-card.full-width {
                grid-column: span 1;
            }
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üìä</div>
            <div>
                <div class="logo-text">Homebody Projects</div>
                <div class="logo-sub">Nashville Permit Analytics</div>
            </div>
        </div>
        <nav class="header-nav">
            <a href="nashville_permit_explorer_v3.html">üó∫Ô∏è Permit Map</a>
            <a href="#" class="active">üìä Analytics</a>
        </nav>
    </header>
    
    <!-- Summary Cards -->
    <section class="summary-section">
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-card-value" id="totalPermits">‚Äî</div>
                <div class="summary-card-label">Total Permits</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value green" id="totalValue">‚Äî</div>
                <div class="summary-card-label">Total Value</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value blue" id="avgValue">‚Äî</div>
                <div class="summary-card-label">Avg Permit Value</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value orange" id="totalContractors">‚Äî</div>
                <div class="summary-card-label">Contractors</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="totalProperties">‚Äî</div>
                <div class="summary-card-label">Properties</div>
            </div>
        </div>
    </section>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Contractor Search Panel -->
        <div class="search-panel">
            <div class="panel-header">
                üë∑ Contractor Search
            </div>
            <div class="search-box">
                <input type="text" class="search-input" id="contractorSearch" placeholder="Search contractor name...">
            </div>
            <div class="search-results" id="contractorList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Loading contractors...
                </div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="charts-section">
            <!-- Yearly Trends -->
            <div class="chart-card full-width">
                <div class="chart-title">üìà Permit Activity by Year (1980-2024)</div>
                <div class="chart-container tall">
                    <canvas id="yearlyChart"></canvas>
                </div>
            </div>
            
            <div class="chart-row">
                <!-- Permit Types -->
                <div class="chart-card">
                    <div class="chart-title">üìã Permits by Type</div>
                    <div class="chart-container">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
                
                <!-- Value Distribution -->
                <div class="chart-card">
                    <div class="chart-title">üí∞ Permit Value Distribution</div>
                    <div class="chart-container">
                        <canvas id="valueChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="chart-row">
                <!-- Top Contractors by Permits -->
                <div class="chart-card">
                    <div class="chart-title">üèÜ Top 10 Contractors (by Permits)</div>
                    <div class="chart-container">
                        <canvas id="topContractorsChart"></canvas>
                    </div>
                </div>
                
                <!-- Top Contractors by Value -->
                <div class="chart-card">
                    <div class="chart-title">üíµ Top 10 Contractors (by Value)</div>
                    <div class="chart-container">
                        <canvas id="topValueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Contractor Detail Modal -->
    <div class="modal-overlay" id="contractorModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalContractorName">Contractor Name</div>
                <div class="modal-subtitle" id="modalContractorYears">Active: 2010 - 2024</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-stat">
                        <div class="detail-stat-value" id="modalPermits">0</div>
                        <div class="detail-stat-label">Total Permits</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value" id="modalValue">$0</div>
                        <div class="detail-stat-label">Total Value</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value" id="modalProperties">0</div>
                        <div class="detail-stat-label">Properties</div>
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">Permit Types</div>
                    <div class="permit-type-tags" id="modalTypes"></div>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">Average Permit Value</div>
                    <div id="modalAvgValue" style="font-size: 24px; font-weight: 600; color: #6b8e4e;">$0</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Data storage
        let contractors = [];
        let analytics = null;
        
        // Chart instances
        let yearlyChart, typeChart, valueChart, topContractorsChart, topValueChart;
        
        // Load data
        async function loadData() {
            try {
                // Load contractors
                const contractorsRes = await fetch('https://nataliebaldacci.github.io/DADU-Homebody-Projects/contractors_stats.json');
                const contractorsData = await contractorsRes.json();
                contractors = contractorsData.contractors;
                
                // Load analytics
                const analyticsRes = await fetch('https://nataliebaldacci.github.io/DADU-Homebody-Projects/permit_analytics.json');
                analytics = await analyticsRes.json();
                
                // Render everything
                renderSummary();
                renderContractorList();
                renderCharts();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('contractorList').innerHTML = 
                    '<div class="loading">Error loading data. Please refresh.</div>';
            }
        }
        
        // Render summary cards
        function renderSummary() {
            const s = analytics.summary;
            document.getElementById('totalPermits').textContent = s.total_permits.toLocaleString();
            document.getElementById('totalValue').textContent = '$' + (s.total_value / 1e9).toFixed(1) + 'B';
            document.getElementById('avgValue').textContent = '$' + (s.avg_value / 1000).toFixed(0) + 'k';
            document.getElementById('totalContractors').textContent = s.contractors.toLocaleString();
            document.getElementById('totalProperties').textContent = s.properties.toLocaleString();
        }
        
        // Render contractor list
        function renderContractorList(filter = '') {
            const list = document.getElementById('contractorList');
            let filtered = contractors;
            
            if (filter) {
                const query = filter.toLowerCase();
                filtered = contractors.filter(c => c.name.toLowerCase().includes(query));
            }
            
            // Show top 50
            const display = filtered.slice(0, 50);
            
            if (display.length === 0) {
                list.innerHTML = '<div class="loading">No contractors found</div>';
                return;
            }
            
            list.innerHTML = display.map((c, i) => {
                let badge = '';
                const rank = contractors.indexOf(c) + 1;
                if (rank === 1) badge = '<span class="contractor-badge badge-gold">ü•á #1</span>';
                else if (rank === 2) badge = '<span class="contractor-badge badge-silver">ü•à #2</span>';
                else if (rank === 3) badge = '<span class="contractor-badge badge-bronze">ü•â #3</span>';
                else if (rank <= 10) badge = `<span class="contractor-badge" style="background:#e3f2fd;color:#1565c0;">Top 10</span>`;
                
                return `
                    <div class="contractor-item" onclick="showContractorDetail(${contractors.indexOf(c)})">
                        <div class="contractor-name">${c.name}${badge}</div>
                        <div class="contractor-stats">
                            <span>üìã ${c.permits.toLocaleString()} permits</span>
                            <span>üí∞ $${(c.value / 1e6).toFixed(1)}M</span>
                            <span>üè† ${c.props} properties</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Show contractor detail modal
        function showContractorDetail(index) {
            const c = contractors[index];
            document.getElementById('modalContractorName').textContent = c.name;
            document.getElementById('modalContractorYears').textContent = 
                `Active: ${c.first || '?'} - ${c.last || '?'}`;
            document.getElementById('modalPermits').textContent = c.permits.toLocaleString();
            document.getElementById('modalValue').textContent = '$' + (c.value / 1e6).toFixed(1) + 'M';
            document.getElementById('modalProperties').textContent = c.props.toLocaleString();
            document.getElementById('modalAvgValue').textContent = '$' + (c.avg).toLocaleString();
            
            document.getElementById('modalTypes').innerHTML = (c.types || []).map(t => 
                `<span class="permit-type-tag">${t}</span>`
            ).join('') || '<span style="color:#888;">No type data</span>';
            
            document.getElementById('contractorModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('contractorModal').classList.remove('active');
        }
        
        // Render all charts
        function renderCharts() {
            // Yearly trend chart
            const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
            yearlyChart = new Chart(yearlyCtx, {
                type: 'bar',
                data: {
                    labels: analytics.by_year.map(d => d.year),
                    datasets: [{
                        label: 'Permits',
                        data: analytics.by_year.map(d => d.count),
                        backgroundColor: '#6b8e4e',
                        borderRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: v => v >= 1000 ? (v/1000) + 'k' : v
                            }
                        }
                    }
                }
            });
            
            // Permit types chart
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            const typeData = analytics.by_type.slice(0, 8);
            typeChart = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: typeData.map(d => d.type),
                    datasets: [{
                        data: typeData.map(d => d.count),
                        backgroundColor: [
                            '#6b8e4e', '#3498db', '#f39c12', '#e74c3c',
                            '#9b59b6', '#1abc9c', '#34495e', '#95a5a6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 12, font: { size: 11 } }
                        }
                    }
                }
            });
            
            // Value distribution chart
            const valueCtx = document.getElementById('valueChart').getContext('2d');
            valueChart = new Chart(valueCtx, {
                type: 'bar',
                data: {
                    labels: analytics.value_distribution.map(d => d.range),
                    datasets: [{
                        label: 'Permits',
                        data: analytics.value_distribution.map(d => d.count),
                        backgroundColor: '#3498db',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: v => v >= 1000 ? (v/1000) + 'k' : v
                            }
                        }
                    }
                }
            });
            
            // Top contractors by permits
            const topCtx = document.getElementById('topContractorsChart').getContext('2d');
            const topData = analytics.top_contractors.slice(0, 10);
            topContractorsChart = new Chart(topCtx, {
                type: 'bar',
                data: {
                    labels: topData.map(d => d.name.substring(0, 20) + (d.name.length > 20 ? '...' : '')),
                    datasets: [{
                        label: 'Permits',
                        data: topData.map(d => d.permits),
                        backgroundColor: '#f39c12',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: v => v >= 1000 ? (v/1000) + 'k' : v
                            }
                        }
                    }
                }
            });
            
            // Top contractors by value
            const valueTopCtx = document.getElementById('topValueChart').getContext('2d');
            const valueTop = [...contractors]
                .filter(c => c.name !== 'UNKNOWN')
                .sort((a, b) => b.value - a.value)
                .slice(0, 10);
            topValueChart = new Chart(valueTopCtx, {
                type: 'bar',
                data: {
                    labels: valueTop.map(d => d.name.substring(0, 20) + (d.name.length > 20 ? '...' : '')),
                    datasets: [{
                        label: 'Value',
                        data: valueTop.map(d => d.value),
                        backgroundColor: '#6b8e4e',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: v => '$' + (v / 1e6).toFixed(0) + 'M'
                            }
                        }
                    }
                }
            });
        }
        
        // Search handler
        document.getElementById('contractorSearch').addEventListener('input', (e) => {
            renderContractorList(e.target.value);
        });
        
        // Modal handlers
        document.getElementById('contractorModal').addEventListener('click', (e) => {
            if (e.target.id === 'contractorModal') closeModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // Load on page ready
        loadData();
    </script>
</body>
</html>
