<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nashville Permit Explorer | Homebody Projects</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Avenir Next', -apple-system, BlinkMacSystemFont, sans-serif; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            width: 36px;
            height: 36px;
            background: #6b8e4e;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .logo-text {
            font-size: 20px;
            font-weight: 600;
        }
        .logo-sub {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        /* Search Bar */
        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 30px;
        }
        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
        }
        .search-input::placeholder { color: #999; }
        
        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
        }
        .header-stat {
            text-align: center;
        }
        .header-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #6b8e4e;
        }
        
        /* Filter Bar */
        .filter-bar {
            background: #f8f9fa;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        .filter-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #555;
        }
        .zoom-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .zoom-btn:hover { background: #f0f0f0; }
        
        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 110px);
        }
        
        /* Map */
        #map {
            flex: 1;
            position: relative;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #6b8e4e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
        .loading-progress {
            margin-top: 8px;
            color: #999;
            font-size: 12px;
        }
        
        /* Sidebar */
        .sidebar {
            width: 380px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }
        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .sidebar-stats {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }
        .sidebar-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Property List */
        .property-list {
            flex: 1;
            overflow-y: auto;
        }
        .property-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }
        .property-item:hover {
            background: #f5f8f5;
        }
        .property-item.active {
            background: #e8f5e8;
            border-left: 3px solid #6b8e4e;
        }
        .property-address {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        .property-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
        }
        .property-permits {
            color: #6b8e4e;
            font-weight: 600;
        }
        .property-value {
            color: #2c3e50;
        }
        .property-zoning {
            background: #e8f4f8;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            color: #5a8a9a;
        }
        .property-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 8px;
        }
        .property-item:hover .property-actions {
            display: flex;
        }
        .action-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .action-btn:hover { background: #f0f0f0; }
        
        /* Map Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.2);
        }
        .leaflet-popup-content {
            margin: 12px 15px;
            min-width: 240px;
        }
        .popup-address {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .popup-apn {
            font-size: 11px;
            color: #888;
            margin-bottom: 8px;
            font-family: monospace;
        }
        .popup-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        .popup-stat {
            text-align: center;
        }
        .popup-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #6b8e4e;
        }
        .popup-stat-label {
            font-size: 11px;
            color: #888;
        }
        .popup-link {
            display: block;
            text-align: center;
            padding: 8px;
            background: #6b8e4e;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 13px;
            margin-top: 10px;
            cursor: pointer;
        }
        .popup-link:hover { background: #5a7d3f; }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 12px;
            max-width: 750px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        .modal-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
            font-family: monospace;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }
        .modal-close:hover { background: #e0e0e0; }
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(85vh - 100px);
        }
        
        /* Links Section */
        .links-section {
            margin-bottom: 20px;
        }
        .links-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .links-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .link-card {
            padding: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .link-card:hover {
            border-color: #6b8e4e;
            background: #f8faf8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .link-icon {
            width: 40px;
            height: 40px;
            background: #e8f5e8;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        .link-icon.blue { background: #e8f0f8; }
        .link-icon.orange { background: #fef5e8; }
        .link-icon.purple { background: #f3e8f8; }
        .link-info h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .link-info p {
            font-size: 11px;
            color: #888;
        }
        
        /* No Results */
        .no-results {
            padding: 40px;
            text-align: center;
            color: #888;
        }
        .no-results-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Legend */
        .map-legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 11px;
        }
        .legend-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 4px 0;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
<!-- Homebody Navigation -->
<div id="homebody-nav" style="background:#1e2a38;padding:0 20px;font-family:Montserrat,sans-serif;position:sticky;top:0;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.3);"><div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:56px;"><a href="index.html" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:white;"><div style="width:32px;height:32px;background:#4a9;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px;">üè†</div><span style="font-weight:700;font-size:16px;">Homebody Projects</span></a><div style="display:flex;gap:6px;"><a href="am_i_eligible.html" style="color:rgba(255,255,255,0.85);text-decoration:none;padding:8px 12px;font-size:12px;font-weight:500;">Eligibility</a><a href="dadu_opportunity_explorer_v2.html" style="color:rgba(255,255,255,0.85);text-decoration:none;padding:8px 12px;font-size:12px;font-weight:500;">Explorer</a><a href="nashville_permit_explorer_v3.html" style="color:rgba(255,255,255,0.85);text-decoration:none;padding:8px 12px;font-size:12px;font-weight:500;">Permits</a><a href="dadu_code_legislation_v3.html" style="color:rgba(255,255,255,0.85);text-decoration:none;padding:8px 12px;font-size:12px;font-weight:500;">Code</a></div></div></div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üè†</div>
            <div>
                <div class="logo-text">Homebody Projects</div>
                <div class="logo-sub">Nashville Permit Explorer</div>
            </div>
        </div>
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search address or APN...">
        </div>
        <div class="header-stats">
            <div class="header-stat">
                <div class="header-stat-value" id="totalProps">‚Äî</div>
                <div>Properties</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="totalPermits">‚Äî</div>
                <div>Permits</div>
            </div>
        </div>
    </header>
    
    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="filter-group">
            <span class="filter-label">Min Permits:</span>
            <select class="filter-select" id="filterPermits">
                <option value="1">1+</option>
                <option value="3">3+</option>
                <option value="5">5+</option>
                <option value="10" selected>10+</option>
                <option value="25">25+</option>
                <option value="50">50+</option>
            </select>
        </div>
        <div class="filter-group">
            <span class="filter-label">Zoning:</span>
            <select class="filter-select" id="filterZoning">
                <option value="">All</option>
                <option value="RS">RS (Single Family)</option>
                <option value="R">R (Residential)</option>
                <option value="RM">RM (Multi-Family)</option>
                <option value="MU">MU (Mixed Use)</option>
                <option value="CN">CN (Neighborhood Commercial)</option>
                <option value="CL">CL (Limited Commercial)</option>
            </select>
        </div>
        <div class="filter-group">
            <span class="filter-label">District:</span>
            <select class="filter-select" id="filterDistrict">
                <option value="">All</option>
                <option value="USD">USD (Urban)</option>
                <option value="GSD">GSD (General)</option>
            </select>
        </div>
        <label class="filter-checkbox">
            <input type="checkbox" id="searchAsMove" checked>
            Search as map moves
        </label>
        <div style="flex:1"></div>
        <button class="zoom-btn" onclick="map.setView([36.16, -86.78], 11)">Reset View</button>
    </div>
    
    <!-- Main Content -->
    <div class="main-container">
        <div id="map">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading Nashville permit data...</div>
                <div class="loading-progress" id="loadingProgress">Fetching 105,114 properties</div>
            </div>
            <div class="map-legend">
                <div class="legend-title">Permits</div>
                <div class="legend-item"><div class="legend-dot" style="background:#e74c3c"></div> 20+</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f39c12"></div> 10-19</div>
                <div class="legend-item"><div class="legend-dot" style="background:#6b8e4e"></div> 5-9</div>
                <div class="legend-item"><div class="legend-dot" style="background:#3498db"></div> 1-4</div>
            </div>
        </div>
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Properties in View</div>
                <div class="sidebar-stats">
                    <span>üìç <span id="visibleCount">0</span> visible</span>
                    <span>üìã <span id="visiblePermits">0</span> permits</span>
                    <span>üí∞ $<span id="visibleValue">0</span></span>
                </div>
            </div>
            <div class="property-list" id="propertyList">
                <!-- Properties will be populated here -->
            </div>
        </aside>
    </div>
    
    <!-- Links Modal -->
    <div class="modal-overlay" id="linksModal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="modalTitle">Property Links</div>
                    <div class="modal-subtitle" id="modalSubtitle">APN: ---</div>
                </div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="links-section">
                    <div class="links-section-title">üîç Permit & Building Records</div>
                    <div class="links-grid" id="permitLinks"></div>
                </div>
                <div class="links-section">
                    <div class="links-section-title">üè† Property Information</div>
                    <div class="links-grid" id="propertyLinks"></div>
                </div>
                <div class="links-section">
                    <div class="links-section-title">üìä History & Records</div>
                    <div class="links-grid" id="historyLinks"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([36.16, -86.78], 11);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap, &copy; CartoDB',
            maxZoom: 19
        }).addTo(map);
        
        // Data storage
        let allProperties = [];
        let markers = L.layerGroup().addTo(map);
        let selectedProperty = null;
        
        // Load data from GitHub
        async function loadData() {
            const loadingProgress = document.getElementById('loadingProgress');
            
            try {
                loadingProgress.textContent = 'Connecting to GitHub...';
                
                const response = await fetch('https://nataliebaldacci.github.io/DADU-Homebody-Projects/permits_with_apn.json');
                
                if (!response.ok) throw new Error('Failed to fetch data');
                
                loadingProgress.textContent = 'Parsing data...';
                const data = await response.json();
                
                // Map the compact format to full names
                allProperties = data.d.map(p => ({
                    address: p.a,
                    apn: p.apn,
                    pid: p.pid,
                    lat: p.lat,
                    lon: p.lon,
                    permits: p.p,
                    value: p.v,
                    zoning: p.z,
                    district: p.d
                }));
                
                // Update header stats
                document.getElementById('totalProps').textContent = allProperties.length.toLocaleString();
                const totalPermits = allProperties.reduce((sum, p) => sum + p.permits, 0);
                document.getElementById('totalPermits').textContent = totalPermits.toLocaleString();
                
                loadingProgress.textContent = 'Rendering map...';
                
                // Initial render
                updateMap();
                
                // Hide loading
                document.getElementById('loadingOverlay').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading data:', error);
                loadingProgress.textContent = 'Error loading data. Please refresh.';
            }
        }
        
        // Filter properties based on current filters
        function getFilteredProperties() {
            const minPermits = parseInt(document.getElementById('filterPermits').value);
            const zoning = document.getElementById('filterZoning').value;
            const district = document.getElementById('filterDistrict').value;
            const bounds = map.getBounds();
            
            return allProperties.filter(p => {
                if (p.permits < minPermits) return false;
                if (zoning && !p.zoning.startsWith(zoning)) return false;
                if (district && p.district !== district) return false;
                if (!bounds.contains([p.lat, p.lon])) return false;
                return true;
            });
        }
        
        // Update map markers
        function updateMap() {
            markers.clearLayers();
            
            const filtered = getFilteredProperties();
            const zoom = map.getZoom();
            
            // Limit markers at low zoom levels
            let displayProps = filtered;
            if (zoom < 13 && filtered.length > 500) {
                displayProps = filtered.slice(0, 500);
            } else if (zoom < 15 && filtered.length > 2000) {
                displayProps = filtered.slice(0, 2000);
            }
            
            displayProps.forEach(p => {
                const color = p.permits >= 20 ? '#e74c3c' : 
                              p.permits >= 10 ? '#f39c12' : 
                              p.permits >= 5 ? '#6b8e4e' : '#3498db';
                
                const marker = L.circleMarker([p.lat, p.lon], {
                    radius: Math.min(4 + p.permits * 0.3, 12),
                    fillColor: color,
                    color: '#fff',
                    weight: 1,
                    fillOpacity: 0.8
                });
                
                marker.on('click', () => showPopup(p, marker));
                markers.addLayer(marker);
            });
            
            updateSidebar(filtered);
        }
        
        // Show popup for property
        function showPopup(property, marker) {
            const content = `
                <div class="popup-address">${property.address}</div>
                <div class="popup-apn">APN: ${property.apn} | PID: ${property.pid}</div>
                <div class="popup-stats">
                    <div class="popup-stat">
                        <div class="popup-stat-value">${property.permits}</div>
                        <div class="popup-stat-label">Permits</div>
                    </div>
                    <div class="popup-stat">
                        <div class="popup-stat-value">$${(property.value/1000).toFixed(0)}k</div>
                        <div class="popup-stat-label">Total Value</div>
                    </div>
                </div>
                <div style="font-size:12px;color:#666;margin-bottom:8px;">
                    <strong>Zoning:</strong> ${property.zoning || 'N/A'} &nbsp;|&nbsp; 
                    <strong>District:</strong> ${property.district || 'N/A'}
                </div>
                <div class="popup-link" onclick="openLinksModal('${property.apn}', ${property.pid}, '${property.address.replace(/'/g, "\\'")}', ${property.lat}, ${property.lon})">
                    See All Nashville Links ‚Üí
                </div>
            `;
            
            marker.bindPopup(content).openPopup();
            selectedProperty = property;
        }
        
        // Update sidebar
        function updateSidebar(properties) {
            const list = document.getElementById('propertyList');
            const sorted = [...properties].sort((a, b) => b.permits - a.permits).slice(0, 100);
            
            const totalPermits = properties.reduce((sum, p) => sum + p.permits, 0);
            const totalValue = properties.reduce((sum, p) => sum + p.value, 0);
            
            document.getElementById('visibleCount').textContent = properties.length.toLocaleString();
            document.getElementById('visiblePermits').textContent = totalPermits.toLocaleString();
            document.getElementById('visibleValue').textContent = (totalValue / 1000000).toFixed(1) + 'M';
            
            if (sorted.length === 0) {
                list.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <div>No properties found</div>
                        <div style="font-size:12px;margin-top:8px;">Try adjusting filters or zoom level</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = sorted.map(p => `
                <div class="property-item" onclick="flyToProperty(${p.lat}, ${p.lon})">
                    <div class="property-address">${p.address}</div>
                    <div class="property-meta">
                        <span class="property-permits">üìã ${p.permits} permits</span>
                        <span class="property-value">üí∞ $${(p.value/1000).toFixed(0)}k</span>
                        ${p.zoning ? `<span class="property-zoning">${p.zoning}</span>` : ''}
                    </div>
                    <div class="property-actions">
                        <button class="action-btn" title="Zoom to" onclick="event.stopPropagation(); map.flyTo([${p.lat}, ${p.lon}], 18)">üîç</button>
                        <button class="action-btn" title="Links" onclick="event.stopPropagation(); openLinksModal('${p.apn}', ${p.pid}, '${p.address.replace(/'/g, "\\'")}', ${p.lat}, ${p.lon})">üîó</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Fly to property
        function flyToProperty(lat, lon) {
            map.flyTo([lat, lon], 17);
        }
        
        // Build Nashville links from APN and PID
        function buildLinks(apn, pid, lat, lon) {
            return {
                permit: [
                    { 
                        icon: 'üìã', 
                        iconClass: '', 
                        title: 'Permit History API', 
                        desc: 'XML permit records', 
                        url: `https://maps.nashville.gov/ParcelService/Search.asmx/GetPermitHistory?apn=${apn}` 
                    },
                    { 
                        icon: 'üîç', 
                        iconClass: 'blue', 
                        title: 'ePermits Search', 
                        desc: 'Official permit portal', 
                        url: `https://epermits.nashville.gov/#/search?searchCode=APN&page=1&searchText=${apn}&searchType=permit` 
                    },
                    { 
                        icon: 'üìÑ', 
                        iconClass: 'orange', 
                        title: 'Permit Documents', 
                        desc: 'Scanned permit files', 
                        url: `https://documents.nashville.gov/Request/Form/PermitCodes?parcelnumber=${apn}` 
                    }
                ],
                property: [
                    { 
                        icon: 'üó∫Ô∏è', 
                        iconClass: '', 
                        title: 'Parcel Viewer', 
                        desc: 'Interactive map', 
                        url: `https://maps.nashville.gov/ParcelViewer/PrintRecord.html?pin=${pid}` 
                    },
                    { 
                        icon: 'üõ£Ô∏è', 
                        iconClass: 'blue', 
                        title: 'Street View', 
                        desc: 'Google Maps', 
                        url: `https://www.google.com/maps?q&layer=c&cbll=${lat},${lon}` 
                    },
                    { 
                        icon: 'üè†', 
                        iconClass: 'purple', 
                        title: 'Property Assessor', 
                        desc: 'PADCTN Portal', 
                        url: `https://www.padctn.org/prc/property/${pid}/print` 
                    }
                ],
                history: [
                    { 
                        icon: 'üë§', 
                        iconClass: '', 
                        title: 'Owner History', 
                        desc: 'Deed & ownership records', 
                        url: `https://maps.nashville.gov/ParcelService/Search.asmx/GetOwnerHistory?onlyactive=false&pin=${pid}` 
                    },
                    { 
                        icon: 'üèóÔ∏è', 
                        iconClass: 'orange', 
                        title: 'Property History', 
                        desc: 'Building changes', 
                        url: `https://maps.nashville.gov/ParcelService/Search.asmx/GetPropertyHistory?onlyactive=false&pin=${pid}` 
                    },
                    { 
                        icon: 'üìä', 
                        iconClass: 'blue', 
                        title: 'Zoning History', 
                        desc: 'Zone changes', 
                        url: `https://maps.nashville.gov/ParcelService/Search.asmx/GetZoningHistory?onlyactive=false&pin=${pid}` 
                    },
                    { 
                        icon: 'üí∞', 
                        iconClass: 'purple', 
                        title: 'Assessment History', 
                        desc: 'Value over time', 
                        url: `https://maps.nashville.gov/ParcelService/Search.asmx/GetAssessmentHistory?onlyactive=false&pin=${pid}` 
                    }
                ]
            };
        }
        
        // Render link cards
        function renderLinks(links) {
            return links.map(link => `
                <a href="${link.url}" target="_blank" class="link-card">
                    <div class="link-icon ${link.iconClass}">${link.icon}</div>
                    <div class="link-info">
                        <h4>${link.title}</h4>
                        <p>${link.desc}</p>
                    </div>
                </a>
            `).join('');
        }
        
        // Open links modal with REAL Nashville links
        function openLinksModal(apn, pid, address, lat, lon) {
            const modal = document.getElementById('linksModal');
            document.getElementById('modalTitle').textContent = address;
            document.getElementById('modalSubtitle').textContent = `APN: ${apn}  |  PID: ${pid}`;
            
            const links = buildLinks(apn, pid, lat, lon);
            
            document.getElementById('permitLinks').innerHTML = renderLinks(links.permit);
            document.getElementById('propertyLinks').innerHTML = renderLinks(links.property);
            document.getElementById('historyLinks').innerHTML = renderLinks(links.history);
            
            modal.classList.add('active');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('linksModal').classList.remove('active');
        }
        
        // Event listeners
        document.getElementById('filterPermits').addEventListener('change', updateMap);
        document.getElementById('filterZoning').addEventListener('change', updateMap);
        document.getElementById('filterDistrict').addEventListener('change', updateMap);
        
        map.on('moveend', () => {
            if (document.getElementById('searchAsMove').checked) {
                updateMap();
            }
        });
        
        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query.length < 3) {
                updateMap();
                return;
            }
            
            const matches = allProperties.filter(p => 
                p.address.toLowerCase().includes(query) || 
                p.apn.toLowerCase().includes(query)
            ).slice(0, 100);
            
            if (matches.length > 0) {
                const lats = matches.map(p => p.lat);
                const lons = matches.map(p => p.lon);
                map.fitBounds([
                    [Math.min(...lats), Math.min(...lons)],
                    [Math.max(...lats), Math.max(...lons)]
                ], { padding: [50, 50] });
            }
        });
        
        // Close modal on overlay click
        document.getElementById('linksModal').addEventListener('click', (e) => {
            if (e.target.id === 'linksModal') closeModal();
        });
        
        // Escape key closes modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>
